<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Example (Combined & Enhanced)</title>
    <style id="chat-widget-styles">
        /* CSS will be injected by the script below */
    </style>
    <!-- Separate styles for the bottom search bar -->
    <style>
        /* --- Bottom Search Bar Styles --- */
        #bottom-search-bar {
            position: fixed;
            bottom: 20px; /* Adjust distance from bottom */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: #ffffff; /* White background */
            border: none; /* Remove border */
            padding: 10px 15px; /* Adjusted padding */
            border-radius: 30px; /* Pill shape */
            /* Updated shadow for fade effect + standard shadow */
            box-shadow: 0 0 10px 4px rgba(255, 0, 122, 0.5), /* Fading pink outline (reduced opacity) */
                        0 2px 5px rgba(0, 0, 0, 0.15);      /* Standard subtle shadow */
            width: 450px; /* Adjusted width */
            max-width: 90%; /* Max width for smaller screens */
            z-index: 1001;
            box-sizing: border-box;
         }

        #search-bar-gr-logo { /* Changed ID back */
             height: 40px; /* Made icon bigger and more obvious */
             width: auto;
             margin-right: 0px;
             flex-shrink: 0;
        }

        #search-bar-input {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #000000; /* Changed to black */
            font-size: 16px; /* Explicit font size */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* System font stack */
            line-height: 1.5;
            padding: 5px 0; /* Vertical padding for input */
            min-width: 50px; /* Prevent collapsing */
        }
        #search-bar-input::placeholder {
            color: rgba(0, 0, 0, 0.5); /* Back to darker gray placeholder */
            opacity: 1; /* Ensure placeholder is visible */
        }

        #search-bar-button {
            background-color: #ffffff; /* Back to white background */
            border: none; /* Remove border */
            border-radius: 50%;
            width: 36px;  /* Button size */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }
        /* Removed hover effect to match image */

        #search-bar-button svg {
            width: 20px; /* Arrow icon size */
            height: 20px;
            fill: #FF007A; /* Back to GR Pink arrow */
        }
        /* --- End Bottom Search Bar Styles --- */

        /* --- Autocomplete Suggestions Styles --- */
        #bottom-search-suggestions {
            position: absolute;
            bottom: calc(100% + 10px); /* Increased gap above search bar */
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-height: 280px; /* Further increased max-height */
            overflow-y: auto;
            z-index: 1000; /* Just below search bar (1001) */
            display: none; /* Hidden by default */
        }
        #bottom-search-suggestions ul {
            list-style: none;
            padding: 15px 10px 15px 10px; /* Restore vertical padding */
            margin: 0;
        }
        #bottom-search-suggestions h4 {
            padding: 15px 30px 0px 20px; /* Adjusted padding for alignment */
            margin: 0;
            font-size: 0.95rem; /* Slightly larger header font */
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; /* Cleaner sans-serif stack */
            color: #010911; /* Gray color */
            font-weight: 500; /* Slightly bolder */
            /* border-bottom: 1px solid #eee; Removed border */
        }
        #bottom-search-suggestions li {
            padding: 9px 20px; /* Restore horizontal padding */
            cursor: pointer;
            font-size: 16px; /* Reduced font size */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* System font stack */
            font-weight: normal; /* Ensure font weight matches input */
            color: #333;
            display: flex; /* Align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }
        #bottom-search-suggestions li .suggestion-icon {
            flex-shrink: 0; /* Prevent icon from shrinking */
        }
        #bottom-search-suggestions li span {
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis (...) */
            /* Optional: ensure it takes available space if needed */
            /* flex-grow: 1; */
            /* min-width: 0; */
        }
        #bottom-search-suggestions li:last-child {
            border-bottom: none;
        }
        #bottom-search-suggestions li:hover {
            background-color: #f8f9fa;
        }

        /* --- START: Close Button Styles (Moved logic here) --- */
        /* Default state for the standalone close button: hidden */
        #chat-widget-close-btn {
            display: none;
            /* Base styles needed regardless of state (size, border-radius, etc.) */
            position: absolute; /* Needs absolute positioning */
            width: 36px;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2001; /* High z-index */
        }

        /* Style the standalone close button ONLY when panel is expanded */
        #chat-widget-panel.expanded #chat-widget-close-btn {
             display: flex; /* OVERRIDE display: none; */
             top: 15px;
             right: 20px;
             background: rgba(255, 255, 255, 0.7); /* Slightly opaque white background */
             border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
             align-items: center;
             justify-content: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add subtle shadow */
        }
        /* Style the SVG icon inside the expanded close button */
        #chat-widget-panel.expanded #chat-widget-close-btn svg {
            width: 20px; /* Control icon size */
            height: 20px;
            fill: #333; /* Dark icon color */
        }
        /* --- END: Close Button Styles --- */


        /* Hide header and footer in full screen mode */
        /* This rule is now safe because close button is outside header */
        #chat-widget-panel.expanded .chat-widget-header {
            display: none;
        }
        #chat-widget-panel.expanded .chat-widget-footer {
            display: none; /* Hide input footer */
        }

        /* Spinner Styles */
        @keyframes chat-spinner-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chat-widget-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #FF007A; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: chat-spinner-spin 1s linear infinite;
            position: absolute; /* Center in content area */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default */
            z-index: 10; /* Above content, below header */
        }
        /* Adjusted spinner position for expanded view */
         #chat-widget-panel.expanded #chat-widget-spinner {
            top: 50%; /* Center vertically in viewport */
         }

        #chat-widget-panel.expanded #chat-widget-main-content.loading #chat-widget-spinner {
             display: block; /* Show when loading */
        }

        /* --- START: Espresso Layout Styles --- */
        #chat-widget-panel.expanded #chat-widget-main-content {
            padding: 30px 40px; /* More padding for full screen */
            /* Background handled by panel */
            /* Reserve extra bottom space for the fixed search bar */
            padding-bottom: 140px;
        }

        /* Specific styling ONLY when image response is present */
        #chat-widget-main-content #image-response-container {
            width: 100%;
            max-width: 900px; /* Limit content width for better readability */
            margin: 0 auto; /* Center the content block */
            display: flex;
            flex-direction: column;
            gap: 25px; /* Space between sections */
        }

        .user-query-bubble {
            align-self: flex-end; /* Align to right */
            background-color: #f0f0f0; /* Light gray background */
            color: #333; /* Dark text */
            padding: 12px 18px;
            border-radius: 18px; /* More rounded */
            margin: 0 0 15px 0; /* Margin bottom */
            max-width: 65%; /* Limit width */
            font-size: 1rem;
            line-height: 1.5;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .bot-intro-block {
            display: flex;
            align-items: flex-start; /* Align icon top */
            gap: 12px; /* Space between icon and text */
            color: #333;
            font-size: 1rem;
            line-height: 1.6;
        }
        .bot-intro-block svg { /* Style the bot icon */
            flex-shrink: 0;
            margin-top: 2px; /* Small top margin for alignment */
            width: 24px; /* Match provided icon */
            height: 24px;
        }
         .bot-intro-block p {
             margin: 0; /* Remove default paragraph margin */
         }

        .product-cards-container {
            display: flex;
            justify-content: space-between; /* Space out cards */
            gap: 20px; /* Gap between cards */
            margin: 15px 0;
        }

        .product-card {
            background-color: #f8f9fa; /* Light background for card */
            border-radius: 12px; /* Rounded corners */
            border: 1px solid #eee; /* Subtle border */
            padding: 20px; /* Padding inside card */
            flex: 1; /* Allow cards to grow equally */
            max-width: 31%; /* Approx 1/3 width minus gaps */
            display: flex;
            flex-direction: column;
            text-align: left; /* Align text left */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow */
            box-sizing: border-box;
        }

        .product-image-wrapper {
            position: relative; /* For tag positioning */
            margin-bottom: 15px; /* Space below image */
        }
        .product-image-wrapper img {
            display: block;
            max-width: 100%;
            height: 180px; /* Fixed height for images */
            object-fit: contain; /* Scale image nicely */
            margin: 0 auto; /* Center image */
        }
        .product-tag {
            position: absolute;
            bottom: 8px; /* Position tag near bottom */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black */
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Space between info elements */
        }
        .product-name {
            font-size: 1rem; /* Slightly larger name */
            font-weight: 600; /* Bolder name */
            color: #333;
            margin: 0;
            line-height: 1.3;
            /* Limit lines if needed */
             /* height: 2.6em; */
             /* overflow: hidden; */
        }
        .product-price {
            font-size: 1rem;
            font-weight: 600; /* Bold price */
            color: #333; /* Black price */
            margin: 0;
        }
        .product-details {
            font-size: 0.8rem;
            color: #6c757d; /* Gray details */
            margin: 0;
        }

        .disclaimer-text {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: left;
            margin: 0;
             padding-top: 10px;
             border-top: 1px solid #eee;
        }
        .disclaimer-text a { /* Style potential links in disclaimer */
            color: #555;
            text-decoration: none;
        }
         .disclaimer-text a:hover {
            text-decoration: underline;
         }


        .explanations-section {
            margin-top: 15px; /* Space above explanations */
        }
        .explanations-section h4 {
            font-size: 1.1rem; /* Slightly larger heading */
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
        }
        .explanations-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .explanation-item {
            margin-bottom: 20px; /* Space between explanation items */
            line-height: 1.6;
            font-size: 0.95rem;
        }
        .explanation-item p {
            margin: 0 0 5px 0; /* Small margin below each paragraph */
            color: #495057;
        }
         .explanation-item p:first-child { /* First line (name) */
            font-weight: 600; /* Make name bold */
             color: #333;
         }
        .explanation-item em { /* Style the tag */
            font-style: italic;
            color: #555;
            display: block; /* Make it block for layout */
            margin-left: 15px; /* Indent tag */
            margin-bottom: 8px;
        }
         .explanation-item p:last-child { /* Last line (description) */
            margin-left: 15px; /* Indent description */
            margin-bottom: 0;
         }
         /* Style reference heading to match Related Products */
         #chat-widget-panel.expanded .disclaimer-text h4 {
             font-size: 1.1rem;
             margin-bottom: 15px;
             color: #343a40;
             font-weight: 600;
         }
         /* --- END: Espresso Layout Styles --- */

        /* Extra spacing for markdown content */
        #image-response-container p {
            margin-bottom: 1.2em;
            line-height: 1.6;
        }
        #image-response-container h1,
        #image-response-container h2,
        #image-response-container h3,
        #image-response-container h4 {
            margin-top: 1.5em;
            margin-bottom: 0.75em;
        }
        #image-response-container ul,
        #image-response-container ol {
            margin: 1em 0;
            padding-left: 20px;
        }
        #image-response-container li {
            margin-bottom: 0.5em;
        }
    </style>
</head>
<body>

<h1>My Awesome Web Page</h1>
<p>Some content here...</p>
<p>Scroll down to see the chat icon.</p>
<div style="height: 1000px;"></div> <!-- To make page scrollable -->

<!-- Embedded Chat Widget Script -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(async function() {
    // --- Configuration ---
    const chatIconColor = '#FF007A';
    const chatIconContent = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="28px" height="28px">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>`;

    const panelHeaderTitle = ''; // Can be set dynamically later
    const panelBackgroundColor = '#f8f9fa';
    const panelHeaderColor = '#e9ecef';
    const defaultPanelWidth = '400px';
    const defaultPanelHeight = '550px'; // Slightly taller default
    const expandedPanelWidth = '100vw'; // Full width for espresso layout
    const expandedPanelHeight = '100vh'; // Full height for espresso layout
    const sidebarWidth = '300px';      // Width for citation sidebar (kept for potential future use)
    const inputPlaceholder = 'Type your message...';
    const sendButtonIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
          <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/>
        </svg>`;
     const shrinkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="18px" height="18px">
          <path fill-rule="evenodd" d="M5.5 2.5a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4zM11 9.5a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 1 .5.5zm-5.5 4a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm10-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 0 0 1h4a.5.5 0 0 0 .5-.5z"/>
          <path d="M3.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 1 0v-13a.5.5 0 0 0-.5-.5z"/>
        </svg>`; // Icon for shrinking

    // --- Mock LLM Response Data (Simulating External Load) ---
    // Kept for potential future use, but not used by the current renderBotResponse
    const mockLLMResponse = { /* ... existing mock data ... */ };

    // --- NEW: Mock Espresso Response Data ---
    const mockEspressoResponse = {
        // Full markdown content provided by user
        markdown: `# The Best Coffee Machines of 2025

## Introduction

Home espresso saw another growth spurt in 2025 as more people looked for café-level drinks without the queue. Tech-forward features such as alt-milk steam profiles and app-based brew scheduling are becoming standard, while sustainability options (low-energy modes, recyclable pods) are now key buying criteria.([TechRadar][1]) Below are the five machines that out-performed dozens of competitors in expert tests and real-world tasting.


## Product Reviews

### 1. Breville Barista Touch Impress — *Best Overall Espresso Machine*

**Quick specs**

* **Type:** Bean-to-cup semi-automatic
* **Grinder:** 54 mm steel conical burrs
* **Heating:** ThermoJet system (≈ 3 s to extraction)
* **Milk:** Auto-MilQ wand with dairy + alt-milk presets
* **MSRP:** $1,499

Breville's flagship pairs a lightning-fast ThermoJet heater with an upgraded burr grinder and a sleek touchscreen that walks beginners through dose-tamp-brew steps. Its Auto-MilQ algorithm senses dairy-versus-plant milk and tweaks steam pressure for silky micro-foam every time. In hands-on tests the Touch Impress delivered repeatable 25-second shots at 93  °C and café-quality lattes in under two minutes.([Coffeeness][2], [Coffee Kev][3])

*Why we love it:* barista-grade results and the most intuitive workflow on the market.


### 2. De'Longhi La Specialista Maestro — *Best Semi-Automatic for Milk Lovers*
... (full markdown as given) ...

## References
* [1]: https://www.techradar.com/...
* [2]: https://www.coffeeness.de/... 
        `,
        // Ad unit products
        products: [
            {
                tag: "Versatile Choice",
                name: "De'Longhi ECP3220 Espresso Machine",
                price: "$119.95",
                details: "De'Longhi and 9 others",
                imageUrl: "images/3in1Machine_Ecom_3.webp"
            },
            {
                tag: "Compact Design",
                name: "Gevi Compact Professional Semi-Automatic Espresso...",
                price: "$124.99",
                details: "GEVI and 3 others",
                imageUrl: "images/gevi.jpg"
            },
            {
                tag: "Best Budget Choice",
                name: "De'Longhi Stilosa Manual Espresso Machine",
                price: "$99.95",
                details: "PuriLite",
                imageUrl: "images/2.jpg"
            },
            {
                tag: "Sponsored",
                name: "Special Offer",
                price: "",
                details: "",
                imageUrl: "images/4.png"
            }
        ]
    };

    // --- Placeholder Icons ---
    const agentIconSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="flex-shrink: 0;">
          <path d="M12.0001 9.1716C11.4139 9.1716 10.9411 9.6444 10.9411 10.2306C10.9411 10.8168 11.4139 11.2896 12.0001 11.2896C12.5863 11.2896 13.0591 10.8168 13.0591 10.2306C13.0591 9.6444 12.5863 9.1716 12.0001 9.1716Z"/>
          <path d="M12.0001 12.7105C11.4139 12.7105 10.9411 13.1833 10.9411 13.7695C10.9411 14.3557 11.4139 14.8285 12.0001 14.8285C12.5863 14.8285 13.0591 14.3557 13.0591 13.7695C13.0591 13.1833 12.5863 12.7105 12.0001 12.7105Z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M12.0004 1.91895C6.9798 1.91895 2.91992 5.97883 2.91992 11.0001C2.91992 16.0213 6.9798 20.0812 12.0004 20.0812C17.021 20.0812 21.0809 16.0213 21.0809 11.0001C21.0809 5.97883 17.021 1.91895 12.0004 1.91895ZM4.37758 11.0001C4.37758 6.8009 7.7822 3.37661 12.0004 3.37661C16.2186 3.37661 19.6232 6.8009 19.6232 11.0001C19.6232 15.1993 16.2186 18.6235 12.0004 18.6235C7.7822 18.6235 4.37758 15.1993 4.37758 11.0001Z"/>
          <path d="M8.4654 12.7105C7.8792 12.7105 7.4064 13.1833 7.4064 13.7695C7.4064 14.3557 7.8792 14.8285 8.4654 14.8285C9.0516 14.8285 9.5244 14.3557 9.5244 13.7695C9.5244 13.1833 9.0516 12.7105 8.4654 12.7105Z"/>
          <path d="M15.5345 12.7105C14.9483 12.7105 14.4755 13.1833 14.4755 13.7695C14.4755 14.3557 14.9483 14.8285 15.5345 14.8285C16.1207 14.8285 16.5935 14.3557 16.5935 13.7695C16.5935 13.1833 16.1207 12.7105 15.5345 12.7105Z"/>
        </svg>
    `;
    const domainIconSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="14px" height="14px" style="flex-shrink: 0;">
          <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L8.707 1.5z"/>
          <path d="m7 14 4-4-4 4z"/> <!-- Simple element to make it slightly different -->
          <path d="M2.5 12.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-3z"/>
        </svg>
    `;

    // --- Popular Questions ---
    const popularQuestions = await fetch('https://question-answering.searchiq-qa.workers.dev/popular-questions?domain=gamerevolution.com')
    .then(response => response.json())
    .catch(error => []);

    // --- State Variables ---
    let isExpanded = false;
    let hasChatStarted = false;

    // --- CSS Styles ---
    const styles = `
        :root {
            --chat-widget-default-width: ${defaultPanelWidth};
            --chat-widget-default-height: ${defaultPanelHeight};
            --chat-widget-expanded-width: ${expandedPanelWidth}; /* Changed */
            --chat-widget-expanded-height: ${expandedPanelHeight}; /* Changed */
            --chat-widget-sidebar-width: ${sidebarWidth};
            --chat-widget-icon-color: ${chatIconColor};
            --chat-widget-panel-bg: ${panelBackgroundColor};
            --chat-widget-panel-header-bg: ${panelHeaderColor};
        }

        #chat-widget-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; } /* Reset bottom to 20px */
        #chat-widget-icon { background-color: var(--chat-widget-icon-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease; }
        #chat-widget-icon:hover { transform: scale(1.1); }

        #chat-widget-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: var(--chat-widget-default-width);
            height: var(--chat-widget-default-height);
            max-height: var(--chat-widget-default-height);
            background-color: var(--chat-widget-panel-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden; /* Prevent overflow before layout adjusts */
            display: none;
            flex-direction: column; /* Main axis: top to bottom */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 15px;
            transition: width 0.4s ease, height 0.4s ease, top 0.4s ease, left 0.4s ease, opacity 0.3s ease, border-radius 0.4s ease;
        }

        #chat-widget-panel.open { display: flex; }

        #chat-widget-panel.expanded {
            /* Full Screen Overlay Styles */
            position: fixed; /* Changed to fixed */
            top: 0;
            left: 0;
            width: var(--chat-widget-expanded-width);  /* Use variable */
            height: var(--chat-widget-expanded-height); /* Use variable */
            max-height: var(--chat-widget-expanded-height); /* Use variable */
            border-radius: 0; /* No rounded corners when full screen */
            z-index: 2000; /* Ensure it's above other page content */
            background-color: #fff; /* Ensure white background for full screen */
        }

        .chat-widget-header {
            background-color: var(--chat-widget-panel-header-bg);
            padding: 10px 15px; /* Slightly reduced padding */
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .chat-widget-header-left { display: flex; align-items: center; overflow: hidden; /* Prevent title push */ }
        .chat-widget-header img { height: 24px; margin-right: 10px; flex-shrink: 0; }
        .chat-widget-header h3 { margin: 0; font-size: 1.1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-widget-header-right { display: flex; align-items: center; gap: 5px; /* Space between icons */ }
        .chat-widget-header-btn { /* Base style for header buttons still inside header */
             background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d; padding: 0 5px; line-height: 1; display: flex; align-items: center; justify-content: center;
        }
        .chat-widget-header-btn:hover { color: #333; }

        #chat-widget-shrink-btn { /* Still part of header-right */
            /* display: none; Hidden by default - logic controlled by expanded state */
            font-size: 1.2em; /* Adjust size if needed */
        }
        #chat-widget-panel.expanded #chat-widget-shrink-btn {
            /* Shrink button doesn't make sense in full screen */
            display: none;
        }

        /* Style the standalone close button ONLY when panel is expanded */
        #chat-widget-panel.expanded #chat-widget-close-btn {
             display: flex; /* OVERRIDE display: none; */
             top: 15px;
             right: 20px;
             background: rgba(255, 255, 255, 0.7); /* Slightly opaque white background */
             border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
             align-items: center;
             justify-content: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add subtle shadow */
        }
        /* Style the SVG icon inside the expanded close button */
        #chat-widget-panel.expanded #chat-widget-close-btn svg {
            width: 20px; /* Control icon size */
            height: 20px;
            fill: #333; /* Dark icon color */
        }

        /* Hide header and footer in full screen mode */
        #chat-widget-panel.expanded .chat-widget-header {
            display: none;
        }
        #chat-widget-panel.expanded .chat-widget-footer {
            display: none; /* Hide input footer */
        }


        .chat-widget-body {
            flex-grow: 1;
            overflow: hidden; /* IMPORTANT: Hide overflow here, children will scroll */
            background-color: #fff; /* Default background */
            display: flex; /* Default to column for initial view */
            flex-direction: column;
            min-height: 0; /* Crucial for flex + overflow */
        }
        /* Styles for when sidebar is active (old layout) */
        .chat-widget-body.has-sidebar {
            flex-direction: row; /* Switch to row layout */
        }
        /* When expanded, body background is white from panel */
        #chat-widget-panel.expanded .chat-widget-body {
            background-color: transparent; /* Let panel bg show */
        }

        /* Initial content (questions) container */
        .chat-widget-popular-questions-container {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            flex-shrink: 0; /* Don't let it shrink */
        }
         #chat-widget-panel.expanded .chat-widget-popular-questions-container {
             display: none; /* Hide questions when expanded */
         }
        .chat-widget-popular-questions-container h4 { font-size: 0.75rem; color: #6c757d; margin: 0 0 10px 0; text-transform: uppercase; font-weight: normal; padding: 0; letter-spacing: 0.5px; }
        .chat-widget-questions { list-style: none; padding: 0; margin: 0; }
        .chat-widget-questions li a { display: flex; align-items: center; padding: 10px 0; color: #333; text-decoration: none; font-size: 0.95rem; border-bottom: 1px solid #eee; transition: background-color 0.2s ease; gap: 8px; }
        .chat-widget-questions li:last-child a { border-bottom: none; }
        .chat-widget-questions li a:hover { background-color: #e9ecef; /* margin: 0 -20px; padding: 10px 20px; */ }
        .chat-widget-question-icon { width: 16px; height: 16px; fill: #6c757d; flex-shrink: 0; }

        /* Main Content Area */
        #chat-widget-main-content {
             flex-grow: 1; /* Takes remaining space */
             overflow-y: auto; /* Scrollable */
             padding: 20px 30px; /* Default padding */
             display: flex;
             flex-direction: column;
             background-color: #fff; /* Ensure white background */
             position: relative; /* Needed for spinner positioning */
        }
         /* Expanded view uses main content ONLY */
         #chat-widget-panel.expanded #chat-widget-main-content {
             padding: 30px 40px; /* More padding for full screen */
             /* Background handled by panel */
             /* Reserve extra bottom space for the fixed search bar */
             padding-bottom: 140px;
         }

        /* Area for generated article-like content (OLD LAYOUT - kept for reference) */
        #chat-widget-article-area {
            margin-bottom: 20px; line-height: 1.6;
        }
        #chat-widget-article-area h2 { font-size: 1.4rem; margin-top: 0; margin-bottom: 0.5rem; color: #212529; }
        #chat-widget-article-area .source-link { font-size: 0.9rem; color: #0d6efd; text-decoration: none; display: block; margin-bottom: 1rem; }
        #chat-widget-article-area .source-link:hover { text-decoration: underline;}
        #chat-widget-article-area img.banner { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #chat-widget-article-area p, #chat-widget-article-area ol, #chat-widget-article-area ul { font-size: 1rem; margin-bottom: 1rem; color: #495057; }
        #chat-widget-article-area ol, #chat-widget-article-area ul { padding-left: 25px; }
        #chat-widget-article-area li { margin-bottom: 0.5rem; }
        #chat-widget-article-area strong { color: #343a40; }

        /* Carousel Styles (OLD LAYOUT - kept for reference) */
        #chat-widget-product-carousel { margin: 20px 0; }
        #chat-widget-product-carousel h4 { font-size: 1.1rem; margin-bottom: 15px; color: #343a40; font-weight: 600; }
        .chat-widget-carousel-wrapper { display: flex; overflow-x: auto; gap: 0px; padding-bottom: 15px; /* Space for scrollbar if visible */ scrollbar-width: thin; /* Firefox */ border-top: 1px solid #eee; /* Add border like image */ border-bottom: 1px solid #eee; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar { height: 8px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .chat-widget-product-item { border-right: 1px solid #eee; border-radius: 0px; padding: 15px 10px; text-align: center; width: 180px; flex-shrink: 0; background-color: #fff; }
        .chat-widget-carousel-wrapper .chat-widget-product-item:first-child { border-left: 1px solid #eee; }
        .chat-widget-product-item img { max-width: 100%; height: 140px; object-fit: contain; margin-bottom: 8px; }
        .chat-widget-product-item .product-name { font-size: 0.9rem; font-weight: 500; color: #333; margin-bottom: 3px; height: 3em; overflow: hidden; }
        .chat-widget-product-item .product-price { font-size: 0.95rem; margin-bottom: 5px; color: #e74c3c; font-weight: 600; }
        .chat-widget-product-item .product-price del { color: #999; font-weight: normal; margin-right: 5px; font-size: 0.85rem; }
        .chat-widget-product-item .product-tags { font-size: 0.75rem; color: #777; }

        /* Message Area - only used in non-expanded? -> Now integrated into main content */
        #chat-widget-messages {
            /* This container is less relevant now, content goes directly into main-content */
            /* Styles below are for the old message types if they appear */
            flex-grow: 1;
            line-height: 1.5;
            word-wrap: break-word;
            padding-bottom: 10px;
        }
        #chat-widget-main-content > p.user-message { /* Style for user message directly in main content */
            align-self: flex-end; background-color: #f0f0f0; color: #333; padding: 10px 15px; border-radius: 18px 18px 5px 18px; margin: 5px 0 5px 15%; max-width: 75%; text-align: left; box-sizing: border-box; word-wrap: break-word;
        }
        #chat-widget-main-content > p.bot-message,
        #chat-widget-main-content > p.thinking-message {
            align-self: flex-start; background-color: #e9ecef; color: #333; padding: 10px 15px; border-radius: 18px 18px 18px 5px; margin: 5px 15% 5px 0; max-width: 75%; text-align: left; box-sizing: border-box; word-wrap: break-word;
        }
        #chat-widget-main-content > p.thinking-message { font-style: italic; color: #6c757d; }


        /* Citations Sidebar (Right Column - OLD LAYOUT) */
        #chat-widget-citations-sidebar {
            width: var(--chat-widget-sidebar-width);
            flex-shrink: 0;
            background-color: #f8f9fa; /* Slightly different background */
            border-left: 1px solid #dee2e6;
            padding: 20px 15px;
            overflow-y: auto; /* Scrollable sidebar */
            display: none; /* Hidden by default, shown via JS/CSS */
        }
         #chat-widget-panel.expanded .chat-widget-body.has-sidebar #chat-widget-citations-sidebar {
             display: block; /* Show when expanded and sidebar is active */
         }
         /* Ensure sidebar is hidden in new expanded layout */
         #chat-widget-panel.expanded #chat-widget-citations-sidebar {
            display: none !important; /* Force hide if panel expanded */
         }
        #chat-widget-citations-sidebar h4 { font-size: 0.9rem; color: #333; margin-top: 0; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        #chat-widget-citations-sidebar ul { list-style: none; padding: 0; margin: 0; }
        #chat-widget-citations-sidebar li { margin-bottom: 15px; font-size: 0.85rem; }
        #chat-widget-citations-sidebar li a { color: #0056b3; text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; }
        #chat-widget-citations-sidebar li a:hover { text-decoration: underline; }
        #chat-widget-citations-sidebar .citation-domain-info { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; font-size: 0.8rem; color: #555; }
        #chat-widget-citations-sidebar .citation-domain-info svg { /* Styles for domain icon */ }
        #chat-widget-citations-sidebar li span { color: #555; display: block; font-size: 0.8rem; line-height: 1.4; }

        /* Suggestions */
        #chat-widget-suggestions { position: absolute; bottom: 100%; left: 15px; right: 15px; background-color: #fff; border: 1px solid #dee2e6; border-bottom: none; border-radius: 8px 8px 0 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; z-index: 1001; display: none; margin-bottom: 1px; }
        #chat-widget-suggestions ul { list-style: none; padding: 0; margin: 0; }
        #chat-widget-suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
        #chat-widget-suggestions li:last-child { border-bottom: none; }
        #chat-widget-suggestions li:hover { background-color: #f8f9fa; }

        /* Footer */
        .chat-widget-footer { position: relative; padding: 10px 15px; border-top: 1px solid #dee2e6; background-color: var(--chat-widget-panel-bg); display: flex; align-items: flex-end; flex-shrink: 0; gap: 8px; }
        #chat-widget-input { flex-grow: 1; border: 1px solid #ced4da; border-radius: 18px; padding: 10px 18px; font-size: 1rem; resize: none; min-height: 40px; max-height: 120px; height: 40px; box-sizing: border-box; line-height: 1.4; overflow-y: auto; }
        #chat-widget-input:focus { outline: none; border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25); }
        #chat-widget-send-btn { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; padding: 0; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        #chat-widget-send-btn:hover { background-color: #0056b3; }
        #chat-widget-send-btn:disabled { background-color: #e0e0e0; cursor: not-allowed; }
        #chat-widget-send-btn svg { display: block; }

        /* Spinner (already defined above, included here for context) */
        /* @keyframes chat-spinner-spin { ... } */
        /* #chat-widget-spinner { ... } */
        /* #chat-widget-panel.expanded #chat-widget-main-content.loading #chat-widget-spinner { display: block; } */

        /* --- Espresso Layout Specific Styles (also added to separate style tag for clarity) --- */
        #chat-widget-main-content #image-response-container { width: 100%; max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 25px; }
        .user-query-bubble { align-self: flex-end; background-color: #f0f0f0; color: #333; padding: 12px 18px; border-radius: 18px; margin: 0 0 15px 0; max-width: 65%; font-size: 1rem; line-height: 1.5; box-sizing: border-box; word-wrap: break-word; }
        .bot-intro-block { display: flex; align-items: flex-start; gap: 12px; color: #333; font-size: 1rem; line-height: 1.6; }
        .bot-intro-block svg { flex-shrink: 0; margin-top: 2px; width: 24px; height: 24px; }
        .bot-intro-block p { margin: 0; }
        .product-cards-container { display: flex; justify-content: space-between; gap: 20px; margin: 15px 0; }
        .product-card { background-color: #f8f9fa; border-radius: 12px; border: 1px solid #eee; padding: 20px; flex: 1; max-width: 31%; display: flex; flex-direction: column; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); box-sizing: border-box; }
        .product-image-wrapper { position: relative; margin-bottom: 15px; }
        .product-image-wrapper img { display: block; max-width: 100%; height: 180px; object-fit: contain; margin: 0 auto; }
        .product-tag { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; }
        .product-info { display: flex; flex-direction: column; gap: 5px; }
        .product-name { font-size: 1rem; font-weight: 600; color: #333; margin: 0; line-height: 1.3; }
        .product-price { font-size: 1rem; font-weight: 600; color: #333; margin: 0; }
        .product-details { font-size: 0.8rem; color: #6c757d; margin: 0; }
        .disclaimer-text { font-size: 0.8rem; color: #6c757d; text-align: left; margin: 0; padding-top: 10px; border-top: 1px solid #eee; }
        .disclaimer-text a { color: #555; text-decoration: none; }
        .disclaimer-text a:hover { text-decoration: underline; }
        .explanations-section { margin-top: 15px; }
        .explanations-section h4 { font-size: 1.1rem; font-weight: 600; color: #333; margin: 0 0 15px 0; }
        .explanations-section ul { list-style: none; padding: 0; margin: 0; }
        .explanation-item { margin-bottom: 20px; line-height: 1.6; font-size: 0.95rem; }
        .explanation-item p { margin: 0 0 5px 0; color: #495057; }
        .explanation-item p:first-child { font-weight: 600; color: #333; }
        .explanation-item em { font-style: italic; color: #555; display: block; margin-left: 15px; margin-bottom: 8px; }
        .explanation-item p:last-child { margin-left: 15px; margin-bottom: 0; }
    `;


    // --- Helper Functions ---

    function addMessage(text, type = 'bot', containerId = 'chat-widget-messages') {
        // This function might be less used now for the espresso layout, but kept for potential other responses
        const container = document.getElementById(containerId);
        if (!container) { // If message container gone, try adding to main content
            const mainContent = document.getElementById('chat-widget-main-content');
            if (!mainContent) return null;
             const messageElement = document.createElement('p');
             messageElement.textContent = text;
             messageElement.classList.add(`${type}-message`);
             mainContent.appendChild(messageElement);
             mainContent.scrollTop = mainContent.scrollHeight;
             return messageElement;
        }
        const messageElement = document.createElement('p');
        messageElement.textContent = text;
        messageElement.classList.add(`${type}-message`);
        container.appendChild(messageElement);
        const scrollTarget = document.getElementById('chat-widget-main-content');
        if(scrollTarget) scrollTarget.scrollTop = scrollTarget.scrollHeight;
        return messageElement;
    }

    async function fetchAnswerResponse(userQuery, onUpdate) {
        return new Promise(async (resolve, reject) => {
            // Initialize response object structure
            let responseData = {
                queryContext: userQuery,
                article: {
                    title: '',
                    source: {
                        text: '',
                        url: '#'
                    },
                    relatedProducts: [],
                    bodyMarkdown: ''
                },
                citations: []
            };

            // Buffer for aggregating citation data
            let citationBuffer = '';
            const askFuture = fetch('https://question-answering.searchiq-qa.workers.dev/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    index: 'gamerevolution_com_qa',
                    query: userQuery,
                    stream: true
                })
            })
            .then(async (response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    // Append new chunk to buffer and split by newlines
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep the last incomplete line in the buffer

                    // Process complete lines
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.title) {
                                // Append title content
                                responseData.article.title = responseData.article.title + data.title;
                                // Call update callback with current state
                                onUpdate({ ...responseData });
                            } else if (data.content) {
                                // Append content to bodyMarkdown
                                responseData.article.bodyMarkdown = responseData.article.bodyMarkdown + data.content;
                                // Call update callback with current state
                                onUpdate({ ...responseData });
                            } else if (data.citation) {
                                // Aggregate citation data
                                citationBuffer += data.citation;
                            }
                        }
                    }
                }
                // Process any remaining buffer content
                if (buffer) {
                    const line = buffer.trim();
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        if (data.title) {
                            responseData.article.title = responseData.article.title + data.title;
                            onUpdate({ ...responseData });
                        } else if (data.content) {
                            responseData.article.bodyMarkdown = responseData.article.bodyMarkdown + data.content;
                            onUpdate({ ...responseData });
                        } else if (data.citation) {
                            citationBuffer += data.citation;
                        }
                    }
                }

                // Parse and assign aggregated citations
                const match = citationBuffer.match(/\{.*\}/s);
                if (match) {
                    citationBuffer = match[0];
                    responseData.citations = JSON.parse(citationBuffer).citations;
                    // Final update with citations
                    onUpdate({ ...responseData });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

            const productFuture = fetch('https://question-answering.searchiq-qa.workers.dev/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    query: userQuery
                })
            })
            .then(response => response.json())
            .then(body => {
                responseData.products = body.products
                onUpdate({...responseData, });
            })
            .catch(error => {
                responseData.products = [];
                onUpdate({...responseData, });
            });

            try {
                await Promise.all([askFuture, productFuture]);
                resolve(responseData);
            } catch (error) {
                console.error('Error fetching response:', error);
                reject(error);
            }
        });
    }


    // --- UPDATED renderBotResponse to generate Espresso Layout ---
    function renderBotResponse(userQueryText) {
       const mainContent = document.getElementById('chat-widget-main-content');
       const sidebar = document.getElementById('chat-widget-citations-sidebar'); // Still get ref to hide it
       const body = document.querySelector('#chat-widget-panel .chat-widget-body');
       // Recreate spinner if missing (so future calls always have it)
       let spinnerElement = document.getElementById('chat-widget-spinner');
       if (!spinnerElement) {
           spinnerElement = document.createElement('div');
           spinnerElement.id = 'chat-widget-spinner';
           mainContent.classList.remove('loading');
       }

       if (!mainContent || !body || !spinnerElement) return;

       // --- Clear previous dynamic content ---
       mainContent.innerHTML = ''; // Clear everything inside main content
       mainContent.appendChild(spinnerElement); // Re-add spinner temporarily

       // --- Ensure correct layout state ---
        body.classList.remove('has-sidebar'); // Remove sidebar layout class
        if (sidebar) sidebar.style.display = 'none'; // Hide sidebar if it exists

        // Show spinner and add loading class
        spinnerElement.style.display = 'block';
        mainContent.classList.add('loading');
       
        // --- Create the main container for the espresso response style ---
        const responseContainer = document.createElement('div');
        responseContainer.id = 'image-response-container'; // Container for centering and structure

        // 1. Add User Query Bubble (Use original query text passed to function)
        const userQueryBubble = document.createElement('div');
        userQueryBubble.className = 'user-query-bubble';
        // Use the actual query text, not the one from the mock (more flexible)
        userQueryBubble.textContent = userQueryText;
        responseContainer.appendChild(userQueryBubble);
        
        const mdContainer = document.createElement('div');
        responseContainer.appendChild(mdContainer);

        // --- Insert the whole new container into mainContent ---
        mainContent.appendChild(responseContainer); // Add the structured content

        let hasRenderedFirstChar = false;

        const botResponseFuture =  fetchAnswerResponse(userQueryText, (currentData) => {
            const article = currentData.article ? currentData.article : null;
            // Check if we have at least one character to render
            if (!hasRenderedFirstChar && ((article.title && article.title.length > 0) || (article.bodyMarkdown && article.bodyMarkdown.length > 0))) {
                if (spinnerElement) {
                    spinnerElement.remove();
                }
                hasRenderedFirstChar = true;
            }
            
            // --- Build markdown with citations if present ---
            let fullMarkdown = `${article.title ? `# ${article.title.trim()}\n\n` : ''}${article.bodyMarkdown}`;
            // Append citations as markdown references if available
            if (Array.isArray(currentData.citations) && currentData.citations.length > 0) {
                fullMarkdown += '\n\n## References\n';
                currentData.citations.forEach((c, idx) => {
                    // Each citation: [Title](url) — Domain  <br>Snippet
                    fullMarkdown += `[${c.cite_label}] [` + (c.title || c.domain || 'Source') + `](${c.url || '#'})`;
                    fullMarkdown += '\n\n';
                });
            }
            // 2. Render full markdown as HTML and inject into container
            const mdHtml = marked.parse(fullMarkdown);
            mdContainer.innerHTML = mdHtml;
            // 3. Wrap the main H1 with the GameRevolution icon
            const h1 = mdContainer.querySelector('h1');
            let headerWrapper;
            if (h1) {
                headerWrapper = document.createElement('div');
                headerWrapper.style.display = 'flex'; headerWrapper.style.alignItems = 'center';
                const logo = document.createElement('img');
                logo.src = 'gamerevolution.png'; logo.alt = 'GR Logo';
                logo.style.height = '40px'; logo.style.marginRight = '10px';
                h1.parentNode.insertBefore(headerWrapper, h1);
                headerWrapper.appendChild(logo);
                headerWrapper.appendChild(h1);
            }
            // 4. Inject product carousel immediately below the title
            if (headerWrapper && currentData.products && currentData.products.length && currentData.article.title.length > 0) {
                const carouselContainer = document.createElement('div');
                carouselContainer.id = 'chat-widget-product-carousel';
                const carouselTitle = document.createElement('h4'); carouselTitle.textContent = 'Related Products';
                carouselContainer.appendChild(carouselTitle);
                const carouselWrapper = document.createElement('div'); carouselWrapper.className = 'chat-widget-carousel-wrapper';
                currentData.products.forEach(product => {
                    const item = document.createElement('div'); item.className = 'chat-widget-product-item';
                    item.innerHTML = `
                        <img src="${product.imageUrl}" alt="${product.name}">
                        <p class="product-name">${product.name}</p>
                        <p class="product-price">${product.price}</p>
                        <p class="product-tags">${product.details}</p>
                    `;
                    carouselWrapper.appendChild(item);
                });
                carouselContainer.appendChild(carouselWrapper);
                headerWrapper.insertAdjacentElement('afterend', carouselContainer);
            }
        });
    }


    // --- Panel State Management Functions ---

    function expandPanel() {
        const panel = document.getElementById('chat-widget-panel');
        // Always make panel visible when expanding
        if (!panel.classList.contains('open')) panel.classList.add('open');
        const body = panel.querySelector('.chat-widget-body');
        const popularQuestionsContainer = panel.querySelector('.chat-widget-popular-questions-container');
        let sidebar = document.getElementById('chat-widget-citations-sidebar'); // Get ref even if not used

        if (!isExpanded) {
            panel.classList.add('expanded');
            isExpanded = true;
            hasChatStarted = true; // Expanding implies chat has started

            // Hide popular questions
            if(popularQuestionsContainer) popularQuestionsContainer.style.display = 'none';

            // Ensure sidebar is hidden and correct layout class is absent
            if(sidebar) sidebar.style.display = 'none';
            body.classList.remove('has-sidebar');

             // Scroll main content to top when expanding
             const mainContent = document.getElementById('chat-widget-main-content');
             if(mainContent) mainContent.scrollTop = 0;
        }
    }

    function shrinkPanel() {
        const panel = document.getElementById('chat-widget-panel');
        const body = panel.querySelector('.chat-widget-body');
        const popularQuestionsContainer = panel.querySelector('.chat-widget-popular-questions-container');
        const mainContent = document.getElementById('chat-widget-main-content'); // Get ref to clear

        if (isExpanded) {
            panel.classList.remove('expanded');
            isExpanded = false;

            // Hide sidebar and remove layout class (redundant but safe)
            const sidebar = document.getElementById('chat-widget-citations-sidebar');
            if(sidebar) sidebar.style.display = 'none';
            body.classList.remove('has-sidebar');

            // Show popular questions ONLY if chat hasn't really started
            // Determine "really started" by checking if dynamic content exists
            const dynamicResponse = document.getElementById('image-response-container') || document.getElementById('chat-widget-article-area');
            if (!dynamicResponse && popularQuestionsContainer) {
                 popularQuestionsContainer.style.display = ''; // Show questions
                 if (mainContent) mainContent.innerHTML = ''; // Clear any leftover messages
                 hasChatStarted = false; // Reset if going back to questions
            } else if (dynamicResponse && mainContent) {
                 // If shrinking from a dynamic response, clear it to show messages/questions next time
                 mainContent.innerHTML = '';
                 // Potentially add back the message area container if needed for non-expanded view
                 const messagesArea = document.createElement('div');
                 messagesArea.id = 'chat-widget-messages';
                 mainContent.appendChild(messagesArea);
            }

            // Restore header and footer visibility (handled by CSS removing .expanded class)
        }
    }

    function togglePanel() {
        const panel = document.getElementById('chat-widget-panel');
        const chatInput = document.getElementById('chat-widget-input');

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
            // If closing while expanded, also shrink it conceptually
            if (isExpanded) {
                 shrinkPanel(); // Reset state but keep it hidden
            }
        } else {
            panel.classList.add('open');
            // If chat HAS started (e.g., previous interaction or bottom bar used),
            // AND it's not already expanded, expand it.
            if (hasChatStarted && !isExpanded) {
                 expandPanel();
            }
             // Auto-focus input only if opening to the non-expanded view
            if (!isExpanded && chatInput) {
                setTimeout(() => chatInput.focus(), 50);
            }
        }
    }

    // --- Dynamic Element Creation ---
    function createWidget() {
        // 1. Inject CSS
        const styleSheet = document.getElementById('chat-widget-styles');
        if (styleSheet) styleSheet.textContent = styles;
        else { /* ... create style tag ... */ }

        // 2. Create main container
        const container = document.createElement('div');
        container.id = 'chat-widget-container';

        // 3. Create chat icon
        const iconButton = document.createElement('button');
        iconButton.id = 'chat-widget-icon';
        iconButton.innerHTML = chatIconContent;
        iconButton.setAttribute('aria-label', 'Open Chat');

        // 4. Create chat panel
        const panel = document.createElement('div');
        panel.id = 'chat-widget-panel';

        // 5. Create panel header
        const header = document.createElement('div');
        header.className = 'chat-widget-header';
        // ... (header left/right content as before) ...
        const headerLeft = document.createElement('div'); headerLeft.className = 'chat-widget-header-left';
        const logoImg = document.createElement('img'); logoImg.src = 'https://ad.net/wp-content/themes/wp-adnet/assets/images/adnet.svg'; logoImg.alt = 'Logo';
        const headerTitle = document.createElement('h3'); headerTitle.id = 'chat-widget-header-title'; headerTitle.textContent = panelHeaderTitle;
        headerLeft.appendChild(logoImg); headerLeft.appendChild(headerTitle);
        const headerRight = document.createElement('div'); headerRight.className = 'chat-widget-header-right';
        const shrinkButton = document.createElement('button'); shrinkButton.id = 'chat-widget-shrink-btn'; shrinkButton.className = 'chat-widget-header-btn'; shrinkButton.innerHTML = shrinkIcon; shrinkButton.setAttribute('aria-label', 'Shrink Chat'); shrinkButton.addEventListener('click', shrinkPanel);
        headerRight.appendChild(shrinkButton); // Add shrink button TO HEADER
        header.appendChild(headerLeft); header.appendChild(headerRight);


        // *** Create Close Button (but don't add to header) ***
        const closeButton = document.createElement('button');
        closeButton.id = 'chat-widget-close-btn';
        closeButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        `;
        closeButton.setAttribute('aria-label', 'Close Chat');
        // Listener added later

        // 6. Create panel body
        const body = document.createElement('div');
        body.className = 'chat-widget-body';

        // 6a. Create Popular Questions Container
        const popularQuestionsContainer = document.createElement('div');
        popularQuestionsContainer.className = 'chat-widget-popular-questions-container';
        // ... (populate questions as before) ...
         const questionsTitle = document.createElement('h4'); questionsTitle.textContent = 'Popular Questions';
         const questionList = document.createElement('ul'); questionList.className = 'chat-widget-questions';
         const questionIconSvg = `<svg class="chat-widget-question-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-.229.287-.079.032c-.26.107-.64.026-1.153-.197l-.424-.187-.073.38.23.287.073.032c.417.178.92.22 1.352.22.417 0 .84-.03 1.148-.131l.424-.187.073-.38-.23-.287-.073-.032c-.276-.117-.502-.13-.617-.291l-.569-2.68c-.074-.34.042-.447.288-.47l.45-.083.082-.38-.229-.287zm1.57 4.734c.03-.147.03-.294.03-.431 0-.21-.04-.414-.12-.608l-.24-.63c-.18-.47-.51-.82-.98-1.06l-.27-.135c-.23-.115-.39-.29-.48-.51l-.08-.18c-.08-.19-.11-.39-.11-.59 0-.19.03-.37.08-.54l.09-.28c.17-.54.57-1 1.14-1.23l.29-.115c.26-.1.54-.14.82-.14.29 0 .57.04.83.13l.29.115c.57.23.97.69 1.14 1.23l.09.28c.05.17.08.35.08.54 0 .2-.03.4-.11.59l-.08.18c-.09.22-.25.395-.48.51l-.27.135c-.47.24-.8.59-1.06.98l-.24.63c-.08.194-.12.398-.12.608 0 .137 0 .284.03.431z"/></svg>`;
         popularQuestions.forEach(q => {
             const listItem = document.createElement('li');
             const link = document.createElement('a'); link.href = '#'; link.innerHTML = questionIconSvg + `<span>${q.text}</span>`; link.dataset.query = q.query;
             link.addEventListener('click', (event) => {
                  event.preventDefault();
                  const query = link.dataset.query || q.text;
                  expandPanel(); // Ensures expansion and sets hasChatStarted
                  renderBotResponse(query); // Generate the ESPRESSO response
                  const chatInputElem = document.getElementById('chat-widget-input'); const sendButtonElem = document.getElementById('chat-widget-send-btn');
                  if(chatInputElem) chatInputElem.value = '';
                  if(sendButtonElem) sendButtonElem.disabled = true;
                  const suggestionsContainerElem = document.getElementById('chat-widget-suggestions');
                  if (suggestionsContainerElem) suggestionsContainerElem.style.display = 'none';
             });
             listItem.appendChild(link); questionList.appendChild(listItem);
         });
         popularQuestionsContainer.appendChild(questionsTitle); popularQuestionsContainer.appendChild(questionList);

        // 6b. Create Main Content Area
        const mainContent = document.createElement('div');
        mainContent.id = 'chat-widget-main-content';

        // 6b.1 Add Spinner Placeholder
        const spinner = document.createElement('div');
        spinner.id = 'chat-widget-spinner';
        mainContent.appendChild(spinner);

        // 6c. Create initial Messages Area (might be cleared later)
        const messagesArea = document.createElement('div');
        messagesArea.id = 'chat-widget-messages';
        mainContent.appendChild(messagesArea);

        // Add initial elements to body
        body.appendChild(popularQuestionsContainer); // Questions first
        body.appendChild(mainContent);            // Then main content (holding messages/spinner)

        // 7. Create panel footer
        const footer = document.createElement('div');
        footer.className = 'chat-widget-footer';
        // ... (suggestions container, input, send button as before) ...
         const suggestionsContainer = document.createElement('div'); suggestionsContainer.id = 'chat-widget-suggestions'; const suggestionsList = document.createElement('ul'); suggestionsContainer.appendChild(suggestionsList); footer.appendChild(suggestionsContainer);
         const chatInput = document.createElement('textarea'); chatInput.id = 'chat-widget-input'; chatInput.placeholder = inputPlaceholder; chatInput.rows = 1;
         const sendButton = document.createElement('button'); sendButton.id = 'chat-widget-send-btn'; sendButton.innerHTML = sendButtonIcon; sendButton.setAttribute('aria-label', 'Send Message'); sendButton.disabled = true;
         footer.appendChild(chatInput); footer.appendChild(sendButton);

        // 8. Assemble panel
        panel.appendChild(header);
        panel.appendChild(body);
        panel.appendChild(footer);
        panel.appendChild(closeButton); // *** Add standalone closeButton to PANEL ***

        // 9. Assemble container
        container.appendChild(iconButton);
        container.appendChild(panel);

        // 10. Append to body
        document.body.appendChild(container);

        // --- Event Listeners ---
        iconButton.addEventListener('click', togglePanel);

        // UPDATED Close Button Listener (Handles expanded state reset)
        closeButton.addEventListener('click', () => {
            const panel = document.getElementById('chat-widget-panel');
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
            }
        });


        sendButton.addEventListener('click', () => {
            const messageText = chatInput.value.trim();
            if (messageText) {
                expandPanel(); // Ensure expanded view & set chat started
                renderBotResponse(messageText); // Generate espresso response

                chatInput.value = '';
                sendButton.disabled = true;
                chatInput.style.height = '40px'; // Reset height
                suggestionsContainer.style.display = 'none';
            }
        });

        // Input listener (suggestions, resize, enable button)
        chatInput.addEventListener('input', () => {
            const trimmedValue = chatInput.value.trim();
            sendButton.disabled = trimmedValue.length === 0;
            // Auto-resize
            chatInput.style.height = 'auto';
            const scrollHeight = chatInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(chatInput).maxHeight, 10);
            const minHeight = parseInt(window.getComputedStyle(chatInput).minHeight, 10);
            let newHeight = Math.max(minHeight, scrollHeight);
            newHeight = Math.min(newHeight, maxHeight);
            chatInput.style.height = `${newHeight}px`;
            // Autocomplete
            const currentInput = chatInput.value.toLowerCase().trim();
            suggestionsList.innerHTML = '';
            if (currentInput.length > 0) {
                const filteredSuggestions = popularQuestions.filter(s => s.text.toLowerCase().includes(currentInput));
                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.slice(0, 5).forEach(suggestionText => {
                        const li = document.createElement('li');
                        li.textContent = suggestionText.text;
                        li.addEventListener('click', () => {
                            chatInput.value = suggestionText.text;
                            suggestionsContainer.style.display = 'none';
                            sendButton.disabled = false;
                            chatInput.focus();
                            chatInput.dispatchEvent(new Event('input')); // Trigger input event for height adjust etc.
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsContainer.style.display = 'block';
                } else { suggestionsContainer.style.display = 'none'; }
            } else { suggestionsContainer.style.display = 'none'; }
        });

        // Enter key listener
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && !sendButton.disabled) {
                event.preventDefault();
                sendButton.click();
            }
        });

        // Click outside suggestions listener
        document.addEventListener('click', function(event) {
            if (!footer.contains(event.target) && suggestionsContainer.style.display === 'block') {
                 suggestionsContainer.style.display = 'none';
            }
        });
    }

    // --- Initialization ---
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createWidget);
    } else {
        createWidget();
    }

    // --- Expose functions for external use (e.g., bottom search bar) ---
    window.chatWidget = {
        togglePanel,
        expandPanel,
        shrinkPanel,
        renderBotResponse, // Now generates espresso layout
        getIsExpanded: () => isExpanded,
        setHasChatStarted: (value) => { hasChatStarted = !!value; }
    };

})();
</script>

<!-- Bottom Search Bar HTML -->
<div id="bottom-search-bar">
    <img id="search-bar-gr-logo" src="gamerevolution.png" alt="GameRevolution Logo">
    <input type="text" id="search-bar-input" placeholder="Looking for the best option? Try me!" autocomplete="off">
    <button id="search-bar-button" aria-label="Submit Search" style="padding-right: 2px;">
        <!-- Paper Plane Send Icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#FF007A"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
    <!-- Autocomplete Suggestions Container -->
    <div id="bottom-search-suggestions">
        <h4>Popular Questions</h4>
        <ul></ul>
    </div>
</div>

<!-- Script for Bottom Search Bar Autocomplete -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const searchInput = document.getElementById('search-bar-input');
    const suggestionsContainer = document.getElementById('bottom-search-suggestions');
    const suggestionsList = suggestionsContainer.querySelector('ul');
    const searchButton = document.getElementById('search-bar-button');

    let isTabJustMadeVisible = false;

    const popularQuestions = await fetch('https://question-answering.searchiq-qa.workers.dev/popular-questions?domain=gamerevolution.com')
    .then(response => response.json())
    .catch(error => []);

    // Function to show suggestions
    async function showSuggestions() {
        suggestionsList.innerHTML = ''; // Clear previous suggestions
        const searchIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#6c757d" class="bi bi-search suggestion-icon" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0\"/></svg>';    
        popularQuestions.forEach(question => {
            const li = document.createElement('li');
            li.innerHTML = searchIconSvg + `<span>${question.text}</span>`; // Add icon and wrap text in span
            li.addEventListener('click', () => {
                const queryText = question.text; // Use the clicked question text
                searchInput.value = question.query; // Keep the value temporarily to show selection
                suggestionsContainer.style.display = 'none';

                // --- Trigger full screen chat response ---
                if (queryText && window.chatWidget) { // Check if widget functions are exposed
                    const chatPanel = document.getElementById('chat-widget-panel');

                    // Set chat started state (since user interacted intentionally)
                    window.chatWidget.setHasChatStarted(true);

                    // Open panel if closed - toggle handles this implicitly if needed
                    if (chatPanel && !chatPanel.classList.contains('open')) {
                        window.chatWidget.togglePanel(); // Open it first
                    }

                    // Expand to full screen and simulate response
                    // expandPanel() should be called *after* togglePanel if it wasn't open
                    // Or rely on togglePanel logic to expand if hasChatStarted is true
                    window.chatWidget.expandPanel(); // Explicitly expand
                    window.chatWidget.renderBotResponse(queryText);

                    // Reset bottom search bar input
                    searchInput.value = ''; // Clear after sending to chat
                    searchInput.blur(); // Remove focus
                }
                // --- End trigger ---

            });
            suggestionsList.appendChild(li);
        });
        suggestionsContainer.style.display = 'block';
    }

    // Function to hide suggestions
    function hideSuggestions() {
        setTimeout(() => {
             suggestionsContainer.style.display = 'none';
        }, 150);
    }

    // --- Event Listeners ---
    document.addEventListener('visibilitychange', () => { /* ... visibility handling ... */ });
    searchInput.addEventListener('focus', () => { if (!isTabJustMadeVisible) { showSuggestions(); } });
    searchInput.addEventListener('blur', hideSuggestions);
    suggestionsContainer.addEventListener('mousedown', (event) => { event.preventDefault(); });
    document.addEventListener('click', (event) => { /* ... hide on outside click ... */ });
    searchInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); searchButton.click(); } });

    // --- Add listener to bottom search button ---
    searchButton.addEventListener('click', () => {
        const queryText = searchInput.value.trim();
        if (queryText && window.chatWidget) {
            const chatPanel = document.getElementById('chat-widget-panel');

             // Set chat started state (since user interacted intentionally)
             window.chatWidget.setHasChatStarted(true);

             // Open panel if closed
            if (chatPanel && !chatPanel.classList.contains('open')) {
                window.chatWidget.togglePanel(); // Open it first
            }

            // Expand to full screen and simulate response
            window.chatWidget.expandPanel(); // Explicitly expand
            window.chatWidget.renderBotResponse(queryText);

            // Reset bottom search bar
            searchInput.value = '';
            suggestionsContainer.style.display = 'none';
            searchInput.blur();
        }
    });
});
</script>

</body>
</html>