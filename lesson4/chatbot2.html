<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Example (Combined & Improved)</title>
    <style id="chat-widget-styles">
        /* CSS will be injected by the script below */
    </style>
</head>
<body>

<h1>My Awesome Web Page</h1>
<p>Some content here...</p>
<p>Scroll down to see the chat icon.</p>
<div style="height: 1000px;"></div> <!-- To make page scrollable -->

<!-- Embedded Chat Widget Script -->
<script>
(function() {
    // --- Configuration ---
    const chatIconColor = '#1a1a1a'; // Example: Dark color for icon background
    const chatIconContent = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="28px" height="28px">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>`; // SVG Icon

    const panelHeaderTitle = ''; // Removed title text
    const panelBackgroundColor = '#f8f9fa'; // Light background for panel
    const panelHeaderColor = '#e9ecef'; // Slightly different header bg
    const defaultPanelWidth = '400px'; // Default width
    const defaultPanelHeight = '500px'; // Default height
    const expandedPanelWidth = '80vw';   // Expanded width (e.g., 80% of viewport width)
    const expandedPanelHeight = '80vh';  // Expanded height (e.g., 80% of viewport height)
    const sendButtonText = 'Send'; // Changed button text (not used, using icon)
    const inputPlaceholder = 'Type your message...';
    const sendButtonIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
          <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/>
        </svg>`; // Send icon SVG

    // --- Updated Popular Questions ---
    const popularQuestions = [
        { text: 'What monitor is best for competitive FPS?', query: 'best monitor for competitive FPS' },
        { text: 'How do I choose the right gaming chair?', query: 'how to choose gaming chair' },
        { text: 'Mechanical vs Membrane keyboards for gaming?', query: 'mechanical vs membrane keyboards gaming' },
        { text: 'Where can I find PS5 stock updates?', query: 'PS5 stock updates' },
        { text: "What's the return policy on peripherals?", query: 'return policy peripherals' }
    ];

    // --- Sample Autocomplete Data ---
    const autocompleteSuggestions = [
        "How do I reset my password?",
        "What are your pricing plans?",
        "How can I contact support?",
        "Where is my invoice?",
        "How to upgrade my account?",
        "Can I get a demo?",
        "What features do you offer?",
        "best monitor for competitive FPS",
        "how to choose gaming chair",
        "mechanical vs membrane keyboards gaming",
        "PS5 stock updates",
        "return policy peripherals"
    ];

    // --- State Variables ---
    let isExpanded = false; // Track panel expanded state
    let hasChatStarted = false; // Track if a message has been sent or question clicked

    // --- CSS Styles ---
    const styles = `
        :root {
            --chat-widget-default-width: ${defaultPanelWidth};
            --chat-widget-default-height: ${defaultPanelHeight};
            --chat-widget-expanded-width: ${expandedPanelWidth};
            --chat-widget-expanded-height: ${expandedPanelHeight};
            --chat-widget-icon-color: ${chatIconColor};
            --chat-widget-panel-bg: ${panelBackgroundColor};
            --chat-widget-panel-header-bg: ${panelHeaderColor};
        }

        #chat-widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        #chat-widget-icon {
            background-color: var(--chat-widget-icon-color);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }

        #chat-widget-icon:hover {
            transform: scale(1.1);
        }

        #chat-widget-panel {
            position: absolute;
            bottom: 70px; /* Position above the icon */
            right: 0;
            width: var(--chat-widget-default-width);
            height: var(--chat-widget-default-height);
            max-height: var(--chat-widget-default-height);
            background-color: var(--chat-widget-panel-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden; /* IMPORTANT: Prevent content overflow before expansion */
            display: none; /* Hidden by default */
            flex-direction: column; /* Use flexbox for layout */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 15px; /* Base font size for rem units */
            transition: width 0.3s ease, height 0.3s ease, bottom 0.3s ease, right 0.3s ease; /* Smooth transition */
        }

        #chat-widget-panel.open {
            display: flex; /* Use flex display */
        }

        /* Styles for the expanded panel */
        #chat-widget-panel.expanded {
            width: var(--chat-widget-expanded-width);
            height: var(--chat-widget-expanded-height);
            max-height: var(--chat-widget-expanded-height);
            bottom: 20px; /* Adjust position */
            right: 20px;  /* Adjust position */
        }

        /* Hide popular questions when expanded */
        #chat-widget-panel.expanded .chat-widget-popular-questions-container {
             display: none;
        }

        .chat-widget-header {
            background-color: var(--chat-widget-panel-header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header shrinking */
        }

        .chat-widget-header img {
            height: 24px;
            margin-right: 10px;
        }

        .chat-widget-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: #333;
            white-space: nowrap; /* Prevent title wrap */
            overflow: hidden;     /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
        }

         .chat-widget-close-btn {
             background: none;
             border: none;
             font-size: 1.5em;
             cursor: pointer;
             color: #6c757d;
             padding: 0 5px;
         }
         .chat-widget-close-btn:hover {
             color: #333;
         }

        .chat-widget-body {
            flex-grow: 1; /* Takes available vertical space */
            overflow-y: auto; /* Scroll if content overflows */
            padding: 15px 20px; /* Padding for content inside body */
            background-color: #fff; /* White background for message area */
            display: flex; /* Use flex to help manage children like message area */
            flex-direction: column; /* Stack children vertically */
            min-height: 0; /* CRUCIAL for flex-grow and overflow-y to work correctly */
        }

        /* Container specifically for popular questions (initially visible) */
        .chat-widget-popular-questions-container {
            padding-bottom: 15px; /* Space below questions */
             border-bottom: 1px solid #eee; /* Separator */
             margin-bottom: 15px; /* Space below separator */
        }

         .chat-widget-popular-questions-container h4 {
             font-size: 0.75rem;
             color: #6c757d;
             margin: 0 0 10px 0;
             text-transform: uppercase;
             font-weight: normal;
             padding: 0; /* Reset padding, rely on body padding */
             letter-spacing: 0.5px;
         }

        .chat-widget-questions {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chat-widget-questions li a {
            display: flex;
            align-items: center;
            padding: 10px 0; /* Use body padding */
            color: #333;
            text-decoration: none;
            font-size: 0.95rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
            gap: 8px;
        }
         .chat-widget-questions li:last-child a {
              border-bottom: none;
          }

        .chat-widget-questions li a:hover {
            background-color: #e9ecef; /* Needs margin/padding adjustment to look good */
             /* Consider adding slight horizontal padding on hover if needed */
             /* margin: 0 -20px; padding: 10px 20px; */
        }

        .chat-widget-question-icon {
            width: 16px;
            height: 16px;
            fill: #6c757d;
            flex-shrink: 0;
        }

        /* Message Area - always present, grows */
        #chat-widget-messages {
             flex-grow: 1; /* Fill available space within body */
             /* Styles for individual messages */
             line-height: 1.5;
             margin-bottom: 10px; /* Space above footer */
             word-wrap: break-word;
        }

        #chat-widget-messages p {
            font-size: 1rem;
            margin: 0 0 0.8em 0;
            max-width: 85%; /* Prevent messages taking full width */
            padding: 8px 12px;
            border-radius: 15px;
            background-color: #e9ecef; /* Default message bg */
            clear: both; /* Ensure floats don't interfere */
            display: block; /* Or inline-block */
        }
        #chat-widget-messages p.user-message {
            background-color: #007bff;
            color: white;
            float: right; /* Align user messages to the right */
            margin-left: 15%; /* Push from left */
            text-align: left; /* Keep text left-aligned within the bubble */
        }
        #chat-widget-messages p.bot-message {
            background-color: #e9ecef;
            color: #333;
            float: left; /* Align bot messages to the left */
            margin-right: 15%; /* Push from right */
        }
        #chat-widget-messages p.thinking-message {
            font-style: italic;
            color: #6c757d;
            background-color: transparent;
            float: left;
            margin-right: 15%;
            padding: 5px 0;
        }

         /* Clearfix for floats within messages div */
        #chat-widget-messages::after {
            content: "";
            display: table;
            clear: both;
        }

        /* Suggestions container positioning relative to footer */
        #chat-widget-suggestions {
            position: absolute;
            bottom: 100%;
            left: 15px;
            right: 15px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            max-height: 180px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            margin-bottom: 1px;
        }

        #chat-widget-suggestions ul { list-style: none; padding: 0; margin: 0; }
        #chat-widget-suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
        #chat-widget-suggestions li:last-child { border-bottom: none; }
        #chat-widget-suggestions li:hover { background-color: #f8f9fa; }

        .chat-widget-footer {
            position: relative; /* Needed for absolute positioning of suggestions */
            padding: 10px 15px;
            border-top: 1px solid #dee2e6;
            background-color: var(--chat-widget-panel-bg);
            display: flex;
            align-items: flex-end;
            flex-shrink: 0; /* Prevent footer shrinking */
            gap: 8px;
        }

        #chat-widget-input {
            flex-grow: 1;
            border: 1px solid #ced4da;
            border-radius: 18px;
            padding: 10px 18px;
            font-size: 1rem;
            resize: none;
            min-height: 40px; /* Adjusted min height */
            max-height: 120px; /* Adjusted max height */
            height: 40px; /* Initial height */
            box-sizing: border-box;
            line-height: 1.4;
            overflow-y: auto;
        }
         #chat-widget-input:focus {
             outline: none;
             border-color: #86b7fe;
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
         }

        #chat-widget-send-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            padding: 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #chat-widget-send-btn:hover { background-color: #0056b3; }
        #chat-widget-send-btn:disabled { background-color: #e0e0e0; cursor: not-allowed; }
        #chat-widget-send-btn svg { display: block; }
    `;

    // --- Helper Functions ---

    // Adds a message to the chat display
    function addMessage(text, type = 'bot') { // type can be 'user', 'bot', 'thinking'
        const messagesArea = document.getElementById('chat-widget-messages');
        if (!messagesArea) return;

        const messageElement = document.createElement('p');
        messageElement.textContent = text;
        messageElement.classList.add(`${type}-message`); // Add class based on type

        messagesArea.appendChild(messageElement);
        // Scroll to the bottom
        messagesArea.scrollTop = messagesArea.scrollHeight;
        return messageElement; // Return the element if we need to remove it (e.g., 'thinking' message)
    }

    // Simulates getting a response
    function simulateBotResponse(query) {
       const thinkingMsg = addMessage('Thinking...', 'thinking');

        setTimeout(() => {
            if(thinkingMsg) thinkingMsg.remove(); // Remove "Thinking..." message
            const response = `This is a simulated response for: "${query}". In a real application, this would be generated based on your query and might include more details, formatting, or citations.`;
            addMessage(response, 'bot');
        }, 1500); // Simulate network delay
    }


    // --- Dynamic Element Creation ---
    function createWidget() {
        // 1. Inject CSS
        const styleSheet = document.getElementById('chat-widget-styles');
        if (styleSheet) {
            styleSheet.textContent = styles;
        } else {
            console.error('Chat Widget Error: Could not find #chat-widget-styles tag.');
            const styleEl = document.createElement('style');
            styleEl.textContent = styles;
            document.head.appendChild(styleEl);
        }

        // 2. Create main container
        const container = document.createElement('div');
        container.id = 'chat-widget-container';

        // 3. Create chat icon
        const iconButton = document.createElement('button');
        iconButton.id = 'chat-widget-icon';
        iconButton.innerHTML = chatIconContent;
        iconButton.setAttribute('aria-label', 'Open Chat');

        // 4. Create chat panel
        const panel = document.createElement('div');
        panel.id = 'chat-widget-panel';

        // 5. Create panel header
        const header = document.createElement('div');
        header.className = 'chat-widget-header';
        const headerTitle = document.createElement('h3');
        headerTitle.textContent = panelHeaderTitle;

        const logoImg = document.createElement('img');
        logoImg.src = 'https://ad.net/wp-content/themes/wp-adnet/assets/images/adnet.svg';
        logoImg.alt = 'Logo';

        const logoTitleContainer = document.createElement('div');
        logoTitleContainer.style.display = 'flex';
        logoTitleContainer.style.alignItems = 'center';
        logoTitleContainer.appendChild(logoImg);
        logoTitleContainer.appendChild(headerTitle);

        const closeButton = document.createElement('button');
        closeButton.className = 'chat-widget-close-btn';
        closeButton.innerHTML = 'Ã—';
        closeButton.setAttribute('aria-label', 'Close Chat');

        header.appendChild(logoTitleContainer);
        header.appendChild(closeButton);

        // 6. Create panel body (consistent structure)
        const body = document.createElement('div');
        body.className = 'chat-widget-body';

        // 6a. Create Popular Questions Container (initially visible)
        const popularQuestionsContainer = document.createElement('div');
        popularQuestionsContainer.className = 'chat-widget-popular-questions-container';

        const questionsTitle = document.createElement('h4');
        questionsTitle.textContent = 'Popular Questions';

        const questionList = document.createElement('ul');
        questionList.className = 'chat-widget-questions';
        const questionIconSvg = `
            <svg class="chat-widget-question-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
            </svg>`;

        popularQuestions.forEach(q => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#'; // Prevent page jump
            link.textContent = q.text;
            link.dataset.query = q.query;
            link.innerHTML = questionIconSvg + link.innerHTML;

            link.addEventListener('click', (event) => {
                 event.preventDefault();
                 const query = link.dataset.query || q.text;
                 addMessage(query, 'user'); // Add question as user message
                 expandAndRespond(query); // Expand and get bot response
                 // Optionally clear input and disable send if needed
                 const chatInput = document.getElementById('chat-widget-input');
                 const sendButton = document.getElementById('chat-widget-send-btn');
                 chatInput.value = '';
                 sendButton.disabled = true;
            });
            listItem.appendChild(link);
            questionList.appendChild(listItem);
        });

        popularQuestionsContainer.appendChild(questionsTitle);
        popularQuestionsContainer.appendChild(questionList);

        // 6b. Create Messages Area (always present)
        const messagesArea = document.createElement('div');
        messagesArea.id = 'chat-widget-messages';

        // Add initial elements to body
        body.appendChild(popularQuestionsContainer); // Add questions first
        body.appendChild(messagesArea);             // Then the message area

        // 7. Create panel footer
        const footer = document.createElement('div');
        footer.className = 'chat-widget-footer';

        // 7.5 Create Suggestions container
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.id = 'chat-widget-suggestions';
        const suggestionsList = document.createElement('ul');
        suggestionsContainer.appendChild(suggestionsList);
        // Append suggestions container *before* input/button in the footer's DOM
        // but use absolute positioning to place it visually above.
        footer.appendChild(suggestionsContainer);

        const chatInput = document.createElement('textarea');
        chatInput.id = 'chat-widget-input';
        chatInput.placeholder = inputPlaceholder;
        chatInput.rows = 1;
        const sendButton = document.createElement('button');
        sendButton.id = 'chat-widget-send-btn';
        sendButton.innerHTML = sendButtonIcon;
        sendButton.setAttribute('aria-label', 'Send Message');
        sendButton.disabled = true;

        footer.appendChild(chatInput);
        footer.appendChild(sendButton);

        // 8. Assemble panel
        panel.appendChild(header);
        panel.appendChild(body);
        panel.appendChild(footer);

        // 9. Assemble container
        container.appendChild(iconButton);
        container.appendChild(panel);

        // 10. Append to body
        document.body.appendChild(container);

        // --- Event Listeners ---

        // Function to handle expanding the panel and simulating response
        function expandAndRespond(query) {
            if (!isExpanded) {
                panel.classList.add('expanded');
                isExpanded = true;
            }
            hasChatStarted = true; // Mark that interaction has begun
            simulateBotResponse(query);
            // Ensure input gets focus after expansion/response trigger
            setTimeout(() => chatInput.focus(), 0);
        }

        // Toggle panel visibility
        function togglePanel() {
            const isOpen = panel.classList.contains('open');
            if (isOpen) {
                panel.classList.remove('open');
                // Reset expansion state ONLY when closing
                if (isExpanded) {
                    panel.classList.remove('expanded');
                    isExpanded = false;
                }
                // Optional: Reset hasChatStarted if you want questions
                // to reappear every time it's reopened after closing.
                // hasChatStarted = false;
                // panel.querySelector('.chat-widget-popular-questions-container').style.display = '';

            } else {
                panel.classList.add('open');
                // If chat has started, immediately go to expanded view on open
                if (hasChatStarted && !isExpanded) {
                     panel.classList.add('expanded');
                     isExpanded = true;
                }
                 // Auto-focus input when opened
                 setTimeout(() => chatInput.focus(), 50); // Small delay for transition
            }
        }

        iconButton.addEventListener('click', togglePanel);
        closeButton.addEventListener('click', togglePanel);


        // Send button action
        sendButton.addEventListener('click', () => {
            const messageText = chatInput.value.trim();
            if (messageText) {
                addMessage(messageText, 'user'); // Add user message to display
                expandAndRespond(messageText);   // Expand (if needed) and get bot response

                // Clear input & reset UI
                chatInput.value = '';
                sendButton.disabled = true;
                chatInput.style.height = '40px'; // Reset height
                suggestionsContainer.style.display = 'none';
                chatInput.focus(); // Keep focus on input
            }
        });

        // Enable/disable send button & handle autocomplete & resize input
        chatInput.addEventListener('input', () => {
            const trimmedValue = chatInput.value.trim();
            sendButton.disabled = trimmedValue.length === 0;

            // Auto-resize textarea height
            chatInput.style.height = 'auto'; // Temporarily shrink to get correct scrollHeight
            const scrollHeight = chatInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(chatInput).maxHeight, 10);
            const minHeight = parseInt(window.getComputedStyle(chatInput).minHeight, 10);

            // Calculate desired height, clamped between min/max
            let newHeight = Math.max(minHeight, scrollHeight);
            newHeight = Math.min(newHeight, maxHeight);

            chatInput.style.height = `${newHeight}px`;

            // Autocomplete Logic
            const currentInput = chatInput.value.toLowerCase().trim();
            suggestionsList.innerHTML = ''; // Clear previous suggestions

            if (currentInput.length > 0) {
                const filteredSuggestions = autocompleteSuggestions.filter(s =>
                    s.toLowerCase().includes(currentInput)
                );

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.slice(0, 5).forEach(suggestionText => { // Limit suggestions shown
                        const li = document.createElement('li');
                        li.textContent = suggestionText;
                        li.addEventListener('click', () => {
                            chatInput.value = suggestionText;
                            suggestionsContainer.style.display = 'none';
                            sendButton.disabled = false;
                            chatInput.focus();
                            // Trigger input event again to resize correctly after setting value
                            chatInput.dispatchEvent(new Event('input'));
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            } else {
                suggestionsContainer.style.display = 'none';
            }
        });

        // Send message on Enter key press (but not Shift+Enter)
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && !sendButton.disabled) {
                event.preventDefault(); // Prevent newline in textarea
                sendButton.click();     // Trigger send button click
            }
        });

        // Hide suggestions when clicking outside the suggestions or input area
        document.addEventListener('click', function(event) {
            if (!footer.contains(event.target) && suggestionsContainer.style.display === 'block') {
                 suggestionsContainer.style.display = 'none';
            }
        });
    }

    // --- Initialization ---
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createWidget);
    } else {
        // DOM is already loaded
        createWidget();
    }

})();
</script>

</body>
</html>