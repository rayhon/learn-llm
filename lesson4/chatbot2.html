<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Example (Combined & Enhanced)</title>
    <style id="chat-widget-styles">
        /* CSS will be injected by the script below */
    </style>
    <!-- Separate styles for the bottom search bar -->
    <style>
        /* --- Bottom Search Bar Styles --- */
        #bottom-search-bar {
            position: fixed;
            bottom: 20px; /* Adjust distance from bottom */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: #ffffff; /* White background */
            border: none; /* Remove border */
            padding: 10px 15px; /* Adjusted padding */
            border-radius: 30px; /* Pill shape */
            /* Updated shadow for fade effect + standard shadow */
            box-shadow: 0 0 10px 4px rgba(255, 0, 122, 0.5), /* Fading pink outline (reduced opacity) */
                        0 2px 5px rgba(0, 0, 0, 0.15);      /* Standard subtle shadow */
            width: 450px; /* Adjusted width */
            max-width: 90%; /* Max width for smaller screens */
            z-index: 1001;
            box-sizing: border-box;
         }

        #search-bar-gr-logo { /* Changed ID back */
             height: 40px; /* Made icon bigger and more obvious */
             width: auto;
             margin-right: 0px;
             flex-shrink: 0;
        }

        #search-bar-input {
            flex-grow: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #000000; /* Changed to black */
            font-size: 16px; /* Explicit font size */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* System font stack */
            line-height: 1.5;
            padding: 5px 0; /* Vertical padding for input */
            min-width: 50px; /* Prevent collapsing */
        }
        #search-bar-input::placeholder {
            color: rgba(0, 0, 0, 0.5); /* Back to darker gray placeholder */
            opacity: 1; /* Ensure placeholder is visible */
        }

        #search-bar-button {
            background-color: #ffffff; /* Back to white background */
            border: none; /* Remove border */
            border-radius: 50%;
            width: 36px;  /* Button size */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
            transition: background-color 0.2s ease;
        }
        /* Removed hover effect to match image */

        #search-bar-button svg {
            width: 20px; /* Arrow icon size */
            height: 20px;
            fill: #FF007A; /* Back to GR Pink arrow */
        }
        /* --- End Bottom Search Bar Styles --- */

        /* --- Autocomplete Suggestions Styles --- */
        #bottom-search-suggestions {
            position: absolute;
            bottom: calc(100% + 10px); /* Increased gap above search bar */
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-height: 280px; /* Further increased max-height */
            overflow-y: auto;
            z-index: 1000; /* Just below search bar (1001) */
            display: none; /* Hidden by default */
        }
        #bottom-search-suggestions ul {
            list-style: none;
            padding: 15px 10px 15px 10px; /* Restore vertical padding */
            margin: 0;
        }
        #bottom-search-suggestions h4 {
            padding: 15px 30px 0px 20px; /* Adjusted padding for alignment */
            margin: 0;
            font-size: 0.95rem; /* Slightly larger header font */
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; /* Cleaner sans-serif stack */
            color: #010911; /* Gray color */
            font-weight: 500; /* Slightly bolder */
            /* border-bottom: 1px solid #eee; Removed border */
        }
        #bottom-search-suggestions li {
            padding: 9px 20px; /* Restore horizontal padding */
            cursor: pointer;
            font-size: 16px; /* Reduced font size */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* System font stack */
            font-weight: normal; /* Ensure font weight matches input */
            color: #333;
            display: flex; /* Align icon and text */
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }
        #bottom-search-suggestions li .suggestion-icon {
            flex-shrink: 0; /* Prevent icon from shrinking */
        }
        #bottom-search-suggestions li span {
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis (...) */
            /* Optional: ensure it takes available space if needed */
            /* flex-grow: 1; */
            /* min-width: 0; */
        }
        #bottom-search-suggestions li:last-child {
            border-bottom: none;
        }
        #bottom-search-suggestions li:hover {
            background-color: #f8f9fa;
        }

        /* --- START: Close Button Styles (Moved logic here) --- */
        /* Default state for the standalone close button: hidden */
        #chat-widget-close-btn {
            display: none;
            /* Base styles needed regardless of state (size, border-radius, etc.) */
            position: absolute; /* Needs absolute positioning */
            width: 36px;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2001; /* High z-index */
        }

        /* Style the standalone close button ONLY when panel is expanded */
        #chat-widget-panel.expanded #chat-widget-close-btn {
             display: flex; /* OVERRIDE display: none; */
             top: 15px;
             right: 20px;
             background: rgba(255, 255, 255, 0.7); /* Slightly opaque white background */
             border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
             align-items: center;
             justify-content: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add subtle shadow */
        }
        /* Style the SVG icon inside the expanded close button */
        #chat-widget-panel.expanded #chat-widget-close-btn svg {
            width: 20px; /* Control icon size */
            height: 20px;
            fill: #333; /* Dark icon color */
        }
        /* --- END: Close Button Styles --- */


        /* Hide header and footer in full screen mode */
        /* This rule is now safe because close button is outside header */
        #chat-widget-panel.expanded .chat-widget-header {
            display: none;
        }
        #chat-widget-panel.expanded .chat-widget-footer {
            display: none; /* Hide input footer */
        }

        /* Spinner Styles */
        @keyframes chat-spinner-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chat-widget-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #FF007A; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: chat-spinner-spin 1s linear infinite;
            position: absolute; /* Center in content area */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default */
            z-index: 10; /* Above content, below header */
        }
        #chat-widget-panel.expanded #chat-widget-main-content.loading #chat-widget-spinner {
             display: block; /* Show when loading */
        }
    </style>
</head>
<body>

<h1>My Awesome Web Page</h1>
<p>Some content here...</p>
<p>Scroll down to see the chat icon.</p>
<div style="height: 1000px;"></div> <!-- To make page scrollable -->

<!-- Embedded Chat Widget Script -->
<script>
(function() {
    // --- Configuration ---
    const chatIconColor = '#FF007A';
    const chatIconContent = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24" width="28px" height="28px">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
        </svg>`;

    const panelHeaderTitle = ''; // Can be set dynamically later
    const panelBackgroundColor = '#f8f9fa';
    const panelHeaderColor = '#e9ecef';
    const defaultPanelWidth = '400px';
    const defaultPanelHeight = '550px'; // Slightly taller default
    const expandedPanelWidth = '85vw';  // Wider expansion
    const expandedPanelHeight = '90vh'; // **Increased expanded height**
    const sidebarWidth = '300px';      // Width for citation sidebar
    const inputPlaceholder = 'Type your message...';
    const sendButtonIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px">
          <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"/>
        </svg>`;
     const shrinkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" width="18px" height="18px">
          <path fill-rule="evenodd" d="M5.5 2.5a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4zM11 9.5a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 1 .5.5zm-5.5 4a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm10-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 0 0 1h4a.5.5 0 0 0 .5-.5z"/>
          <path d="M3.5 1a.5.5 0 0 0-.5.5v13a.5.5 0 0 0 1 0v-13a.5.5 0 0 0-.5-.5z"/>
        </svg>`; // Icon for shrinking

    // --- Mock LLM Response Data (Simulating External Load) ---
    const mockLLMResponse = {
        queryContext: "fix up backyard ideas", // Example context, can be ignored for now
        article: {
            title: "54 Backyard Ideas to Upgrade Your Outdoor Space",
            source: {
                text: "thespruce.com › backyard ideas",
                url: "#" // Placeholder link
            },
            relatedProducts: [
                { name: "Camera Product", imageUrl: "https://placehold.co/150x100/f1f1f1/666?text=Camera", originalPrice: "70.00", salePrice: "65.00", tags: "Featured Product, New" },
                { name: "Baby Toy", imageUrl: "https://placehold.co/150x100/f1f1f1/e67e22?text=Drone", originalPrice: "60.00", salePrice: "50.00", tags: "Featured Product, New" },
                { name: "Baby Shoes", imageUrl: "https://placehold.co/150x100/f1f1f1/3498db?text=Shoes", originalPrice: "90.00", salePrice: "85.00", tags: "Featured Product, New" },
                { name: "Sample Product", imageUrl: "https://placehold.co/150x100/f1f1f1/f368e0?text=Pink+Bag", originalPrice: "50.00", salePrice: "40.00", tags: "New" },
                { name: "Baby Product", imageUrl: "https://placehold.co/150x100/f1f1f1/f1c40f?text=Yellow+Bag", originalPrice: "60.00", salePrice: "54.00", tags: "New" },
                 { name: "Another Gadget", imageUrl: "https://placehold.co/150x100/f1f1f1/2ecc71?text=Gadget", originalPrice: null, salePrice: "75.00", tags: "Sale" },
            ],
            // Content in Markdown format
            bodyMarkdown: `
Transforming your backyard into a welcoming and functional space can be both enjoyable and rewarding. Here are several ideas to enhance your outdoor area:

1.  **Create a Cozy Seating Area:** Arrange comfortable outdoor furniture, such as sofas, chairs, or hammocks, to establish a relaxing spot for reading or entertaining guests. Adding colorful cushions and throw pillows can infuse personality and comfort.
2.  **Incorporate Outdoor Lighting:** Enhance ambiance and extend usability into the evenings by installing string lights, lanterns, or solar-powered fixtures. Soft, warm lighting can create a magical atmosphere.
3.  **Add a Fire Pit:** Introducing a fire pit provides a focal point for gatherings and allows for enjoyable evenings outdoors, even when it's cooler.

Remember to consider your budget and the specific needs of your space when planning your backyard upgrade. Even small changes can make a big difference!
            `
        },
        citations: [
            { title: "The Spruce: 43 Backyard Ideas on a Budget", url: "#", domain: "The Spruce", snippet: "August 25, 2024 - Set up a hammock and add pillows, string lighting in trees, blankets..." },
            { title: "Family Handyman: 50 Brilliant Ways to Spruce Up", url: "#", domain: "Family Handyman", snippet: "October 6, 2024 - Make Your Own Cornhole Game. Cornhole boards are a classic backyard game..." },
            { title: "Better Homes & Gardens: 50 Stunning Ideas", url: "#", domain: "Better Homes & Gardens", snippet: "May 7, 2024 - Whether you're looking for patio suggestions, outdoor dining, or a fun space..." },
            { title: "Extra Space Storage: DIY Guide on a Budget", url: "#", domain: "Extra Space Storage", snippet: "September 24, 2024 - Give your outdoor living space a facelift with a calming meditation space..." }
        ]
    };

    // --- Placeholder Icons ---
    const agentIconSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px" style="flex-shrink: 0;">
          <path d="M12.0001 9.1716C11.4139 9.1716 10.9411 9.6444 10.9411 10.2306C10.9411 10.8168 11.4139 11.2896 12.0001 11.2896C12.5863 11.2896 13.0591 10.8168 13.0591 10.2306C13.0591 9.6444 12.5863 9.1716 12.0001 9.1716Z"/>
          <path d="M12.0001 12.7105C11.4139 12.7105 10.9411 13.1833 10.9411 13.7695C10.9411 14.3557 11.4139 14.8285 12.0001 14.8285C12.5863 14.8285 13.0591 14.3557 13.0591 13.7695C13.0591 13.1833 12.5863 12.7105 12.0001 12.7105Z"/>
          <path fill-rule="evenodd" clip-rule="evenodd" d="M12.0004 1.91895C6.9798 1.91895 2.91992 5.97883 2.91992 11.0001C2.91992 16.0213 6.9798 20.0812 12.0004 20.0812C17.021 20.0812 21.0809 16.0213 21.0809 11.0001C21.0809 5.97883 17.021 1.91895 12.0004 1.91895ZM4.37758 11.0001C4.37758 6.8009 7.7822 3.37661 12.0004 3.37661C16.2186 3.37661 19.6232 6.8009 19.6232 11.0001C19.6232 15.1993 16.2186 18.6235 12.0004 18.6235C7.7822 18.6235 4.37758 15.1993 4.37758 11.0001Z"/>
          <path d="M8.4654 12.7105C7.8792 12.7105 7.4064 13.1833 7.4064 13.7695C7.4064 14.3557 7.8792 14.8285 8.4654 14.8285C9.0516 14.8285 9.5244 14.3557 9.5244 13.7695C9.5244 13.1833 9.0516 12.7105 8.4654 12.7105Z"/>
          <path d="M15.5345 12.7105C14.9483 12.7105 14.4755 13.1833 14.4755 13.7695C14.4755 14.3557 14.9483 14.8285 15.5345 14.8285C16.1207 14.8285 16.5935 14.3557 16.5935 13.7695C16.5935 13.1833 16.1207 12.7105 15.5345 12.7105Z"/>
        </svg>
    `;
    const domainIconSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" width="14px" height="14px" style="flex-shrink: 0;">
          <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L8.707 1.5z"/>
          <path d="m7 14 4-4-4 4z"/> <!-- Simple element to make it slightly different -->
          <path d="M2.5 12.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-3z"/>
        </svg>
    `;

    // --- Popular Questions ---
    const popularQuestions = [
        { text: 'What monitor is best for competitive FPS?', query: 'best monitor for competitive FPS' },
        { text: 'How do I choose the right gaming chair?', query: 'how to choose gaming chair' },
        { text: 'What are some great ways to fix up a backyard?', query: 'fix up backyard ideas' }, // Added example
        { text: 'Where can I find PS5 stock updates?', query: 'PS5 stock updates' },
        { text: "What's the return policy on peripherals?", query: 'return policy peripherals' }
    ];

    // --- Autocomplete Data ---
    const autocompleteSuggestions = [
        'best gaming monitor under 300',
        'ergonomic gaming chair review',
        'fix up backyard budget ideas',
        'PS5 restock tracker',
        'mechanical keyboard switch types',
        'how to clean mousepad',
        'GPU comparison chart',
        'headset microphone not working pc',
        'return policy defective item',
        'gift card balance check'
     ]; // Added some examples

    // --- State Variables ---
    let isExpanded = false;
    let hasChatStarted = false;

    // --- CSS Styles ---
    const styles = `
        :root {
            --chat-widget-default-width: ${defaultPanelWidth};
            --chat-widget-default-height: ${defaultPanelHeight};
            --chat-widget-expanded-width: ${expandedPanelWidth};
            --chat-widget-expanded-height: ${expandedPanelHeight}; /* Taller */
            --chat-widget-sidebar-width: ${sidebarWidth};
            --chat-widget-icon-color: ${chatIconColor};
            --chat-widget-panel-bg: ${panelBackgroundColor};
            --chat-widget-panel-header-bg: ${panelHeaderColor};
        }

        #chat-widget-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #chat-widget-icon { background-color: var(--chat-widget-icon-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease; }
        #chat-widget-icon:hover { transform: scale(1.1); }

        #chat-widget-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: var(--chat-widget-default-width);
            height: var(--chat-widget-default-height);
            max-height: var(--chat-widget-default-height);
            background-color: var(--chat-widget-panel-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden; /* Prevent overflow before layout adjusts */
            display: none;
            flex-direction: column; /* Main axis: top to bottom */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 15px;
            transition: width 0.4s ease, height 0.4s ease, top 0.4s ease, left 0.4s ease, opacity 0.3s ease, border-radius 0.4s ease;
        }

        #chat-widget-panel.open { display: flex; }

        #chat-widget-panel.expanded {
            /* Full Screen Overlay Styles */
            position: fixed; /* Changed to fixed */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0; /* No rounded corners when full screen */
            z-index: 2000; /* Ensure it's above other page content */
        }

        .chat-widget-header {
            background-color: var(--chat-widget-panel-header-bg);
            padding: 10px 15px; /* Slightly reduced padding */
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .chat-widget-header-left { display: flex; align-items: center; overflow: hidden; /* Prevent title push */ }
        .chat-widget-header img { height: 24px; margin-right: 10px; flex-shrink: 0; }
        .chat-widget-header h3 { margin: 0; font-size: 1.1em; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .chat-widget-header-right { display: flex; align-items: center; gap: 5px; /* Space between icons */ }
        .chat-widget-header-btn { /* Base style for header buttons still inside header */
             background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6c757d; padding: 0 5px; line-height: 1; display: flex; align-items: center; justify-content: center;
        }
        .chat-widget-header-btn:hover { color: #333; }

        #chat-widget-shrink-btn { /* Still part of header-right */
            /* display: none; Hidden by default - logic controlled by expanded state */
            font-size: 1.2em; /* Adjust size if needed */
        }
        #chat-widget-panel.expanded #chat-widget-shrink-btn {
            /* Shrink button doesn't make sense in full screen */
            display: none;
        }

        /* Default state for the standalone close button: hidden */
        #chat-widget-close-btn {
            display: none;
            /* Base styles needed regardless of state (size, border-radius, etc.) */
            position: absolute; /* Needs absolute positioning */
            width: 36px;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 2001; /* High z-index */
        }

        /* Style the standalone close button ONLY when panel is expanded */
        #chat-widget-panel.expanded #chat-widget-close-btn {
             display: flex; /* OVERRIDE display: none; */
             top: 15px;
             right: 20px;
             background: rgba(255, 255, 255, 0.7); /* Slightly opaque white background */
             border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
             align-items: center;
             justify-content: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Add subtle shadow */
        }
        /* Style the SVG icon inside the expanded close button */
        #chat-widget-panel.expanded #chat-widget-close-btn svg {
            width: 20px; /* Control icon size */
            height: 20px;
            fill: #333; /* Dark icon color */
        }

        /* Hide header and footer in full screen mode */
        /* This rule is now safe because close button is outside header */
        #chat-widget-panel.expanded .chat-widget-header {
            display: none;
        }
        #chat-widget-panel.expanded .chat-widget-footer {
            display: none; /* Hide input footer */
        }


        .chat-widget-body {
            flex-grow: 1;
            overflow: hidden; /* IMPORTANT: Hide overflow here, children will scroll */
            background-color: #fff;
            display: flex; /* Default to column for initial view */
            flex-direction: column;
            min-height: 0; /* Crucial for flex + overflow */
        }
        /* Styles for when sidebar is active */
        .chat-widget-body.has-sidebar {
            flex-direction: row; /* Switch to row layout */
        }

        /* Initial content (questions) container */
        .chat-widget-popular-questions-container {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            flex-shrink: 0; /* Don't let it shrink */
        }
         #chat-widget-panel.expanded .chat-widget-popular-questions-container {
             display: none; /* Hide questions when expanded */
         }
        .chat-widget-popular-questions-container h4 { font-size: 0.75rem; color: #6c757d; margin: 0 0 10px 0; text-transform: uppercase; font-weight: normal; padding: 0; letter-spacing: 0.5px; }
        .chat-widget-questions { list-style: none; padding: 0; margin: 0; }
        .chat-widget-questions li a { display: flex; align-items: center; padding: 10px 0; color: #333; text-decoration: none; font-size: 0.95rem; border-bottom: 1px solid #eee; transition: background-color 0.2s ease; gap: 8px; }
        .chat-widget-questions li:last-child a { border-bottom: none; }
        .chat-widget-questions li a:hover { background-color: #e9ecef; /* margin: 0 -20px; padding: 10px 20px; */ }
        .chat-widget-question-icon { width: 16px; height: 16px; fill: #6c757d; flex-shrink: 0; }

        /* Main Content Area (Left/Center Column when expanded) */
        #chat-widget-main-content {
             flex-grow: 1; /* Takes remaining space */
             overflow-y: auto; /* Scrollable */
             padding: 20px 30px;
             display: flex; /* Allow messages to grow */
             flex-direction: column;
             background-color: #fff; /* Ensure white background */
             position: relative; /* Needed for spinner positioning */
        }
         /* Default view only has messages in the main content area effectively */
         /* When expanded, it contains article + messages */

        /* Area for generated article-like content */
        #chat-widget-article-area {
            margin-bottom: 20px; /* Space between article and chat messages */
            line-height: 1.6;
        }
        #chat-widget-article-area h2 { font-size: 1.4rem; margin-top: 0; margin-bottom: 0.5rem; color: #212529; }
        #chat-widget-article-area .source-link { font-size: 0.9rem; color: #0d6efd; text-decoration: none; display: block; margin-bottom: 1rem; }
        #chat-widget-article-area .source-link:hover { text-decoration: underline;}
        #chat-widget-article-area img.banner { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #chat-widget-article-area p, #chat-widget-article-area ol, #chat-widget-article-area ul { font-size: 1rem; margin-bottom: 1rem; color: #495057; }
        #chat-widget-article-area ol, #chat-widget-article-area ul { padding-left: 25px; }
        #chat-widget-article-area li { margin-bottom: 0.5rem; }
        #chat-widget-article-area strong { color: #343a40; }

        /* Carousel Styles */
        #chat-widget-product-carousel { margin: 20px 0; }
        #chat-widget-product-carousel h4 { font-size: 1.1rem; margin-bottom: 15px; color: #343a40; font-weight: 600; }
        .chat-widget-carousel-wrapper { display: flex; overflow-x: auto; gap: 0px; padding-bottom: 15px; /* Space for scrollbar if visible */ scrollbar-width: thin; /* Firefox */ border-top: 1px solid #eee; /* Add border like image */ border-bottom: 1px solid #eee; }
        /* Hide scrollbar for Chrome/Safari/Edge */
        .chat-widget-carousel-wrapper::-webkit-scrollbar { height: 8px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .chat-widget-carousel-wrapper::-webkit-scrollbar-thumb:hover { background: #aaa; }

        .chat-widget-product-item {
            /* border: 1px solid #eee; REMOVED */
            border-right: 1px solid #eee; /* Separator */
            border-radius: 0px; /* REMOVED radius */
            padding: 15px 10px; /* Adjust padding */
            text-align: center;
            width: 180px;
            flex-shrink: 0;
            background-color: #fff;
            /* transition: box-shadow 0.2s ease; REMOVED */
        }
        .chat-widget-carousel-wrapper .chat-widget-product-item:first-child {
             border-left: 1px solid #eee; /* Add left border only to the first item */
        }
        /* .chat-widget-product-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); REMOVED } */
        .chat-widget-product-item img { max-width: 100%; height: 140px; /* Increased height */ object-fit: contain; margin-bottom: 8px; /* Slightly reduced margin */ }
        .chat-widget-product-item .product-name { font-size: 0.9rem; font-weight: 500; color: #333; margin-bottom: 3px; /* Reduced margin */ height: 2.4em; overflow: hidden; }
        .chat-widget-product-item .product-price { font-size: 0.95rem; margin-bottom: 5px; /* Reduced margin */ color: #e74c3c; font-weight: 600; }
        .chat-widget-product-item .product-price del { color: #999; font-weight: normal; margin-right: 5px; font-size: 0.85rem; }
        .chat-widget-product-item .product-tags { font-size: 0.75rem; color: #777; }

        /* Message Area - always present */
        #chat-widget-messages {
            flex-grow: 1; /* Allows it to push footer down */
            /* The rest of the message styles remain similar */
            line-height: 1.5;
            word-wrap: break-word;
            padding-bottom: 10px; /* Space above footer visual */
            /* Note: User messages might now be directly in main-content, adjust if needed */
            /* Or keep messages here and style differently */
        }
        #chat-widget-main-content > p.user-message { /* Style for user message directly in main content */
            align-self: flex-end; /* Align user message to the right */
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 18px 18px 5px 18px; /* Bubble shape */
            margin: 5px 0 5px 15%; /* Indent from left, margin top/bottom */
            max-width: 75%; /* Limit width */
            text-align: left;
            /* Removed float/clear, relying on flexbox */
            box-sizing: border-box;
            word-wrap: break-word; /* Ensure long words break */
        }
        #chat-widget-messages p.bot-message,
        #chat-widget-messages p.thinking-message {
            align-self: flex-start; /* Align bot message to the left */
            background-color: #e9ecef;
            color: #333;
            padding: 10px 15px;
            border-radius: 18px 18px 18px 5px; /* Bubble shape */
            margin: 5px 15% 5px 0; /* Indent from right, margin top/bottom */
            max-width: 75%; /* Limit width */
            text-align: left;
            /* Removed float/clear, relying on flexbox */
             box-sizing: border-box;
             word-wrap: break-word;
        }
        #chat-widget-messages p.thinking-message {
             font-style: italic;
             color: #6c757d;
        }


        /* Citations Sidebar (Right Column when expanded) */
        #chat-widget-citations-sidebar {
            width: var(--chat-widget-sidebar-width);
            flex-shrink: 0;
            background-color: #f8f9fa; /* Slightly different background */
            border-left: 1px solid #dee2e6;
            padding: 20px 15px;
            overflow-y: auto; /* Scrollable sidebar */
            display: none; /* Hidden by default, shown via JS/CSS */
        }
         #chat-widget-panel.expanded .chat-widget-body.has-sidebar #chat-widget-citations-sidebar {
             display: block; /* Show when expanded and sidebar is active */
         }
        #chat-widget-citations-sidebar h4 { font-size: 0.9rem; color: #333; margin-top: 0; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        #chat-widget-citations-sidebar ul { list-style: none; padding: 0; margin: 0; }
        #chat-widget-citations-sidebar li { margin-bottom: 15px; font-size: 0.85rem; }
        #chat-widget-citations-sidebar li a { color: #0056b3; text-decoration: none; font-weight: 500; display: block; margin-bottom: 3px; }
        #chat-widget-citations-sidebar li a:hover { text-decoration: underline; }
        #chat-widget-citations-sidebar .citation-domain-info { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; font-size: 0.8rem; color: #555; }
        #chat-widget-citations-sidebar .citation-domain-info svg { /* Styles for domain icon */ }
        #chat-widget-citations-sidebar li span { color: #555; display: block; font-size: 0.8rem; line-height: 1.4; }

        /* Suggestions */
        #chat-widget-suggestions { position: absolute; bottom: 100%; left: 15px; right: 15px; background-color: #fff; border: 1px solid #dee2e6; border-bottom: none; border-radius: 8px 8px 0 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); max-height: 180px; overflow-y: auto; z-index: 1001; display: none; margin-bottom: 1px; }
        #chat-widget-suggestions ul { list-style: none; padding: 0; margin: 0; }
        #chat-widget-suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
        #chat-widget-suggestions li:last-child { border-bottom: none; }
        #chat-widget-suggestions li:hover { background-color: #f8f9fa; }

        /* Footer */
        .chat-widget-footer { position: relative; padding: 10px 15px; border-top: 1px solid #dee2e6; background-color: var(--chat-widget-panel-bg); display: flex; align-items: flex-end; flex-shrink: 0; gap: 8px; }
        #chat-widget-input { flex-grow: 1; border: 1px solid #ced4da; border-radius: 18px; padding: 10px 18px; font-size: 1rem; resize: none; min-height: 40px; max-height: 120px; height: 40px; box-sizing: border-box; line-height: 1.4; overflow-y: auto; }
        #chat-widget-input:focus { outline: none; border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25); }
        #chat-widget-send-btn { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; padding: 0; cursor: pointer; transition: background-color 0.2s ease; flex-shrink: 0; display: flex; justify-content: center; align-items: center; }
        #chat-widget-send-btn:hover { background-color: #0056b3; }
        #chat-widget-send-btn:disabled { background-color: #e0e0e0; cursor: not-allowed; }
        #chat-widget-send-btn svg { display: block; }

        /* Spinner Styles */
        @keyframes chat-spinner-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #chat-widget-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #FF007A; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: chat-spinner-spin 1s linear infinite;
            position: absolute; /* Center in content area */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default */
            z-index: 10; /* Above content, below header */
        }
        #chat-widget-panel.expanded #chat-widget-main-content.loading #chat-widget-spinner {
             display: block; /* Show when loading */
        }
    `;


    // --- Helper Functions ---

    function addMessage(text, type = 'bot', containerId = 'chat-widget-messages') {
        const container = document.getElementById(containerId);
        if (!container) return null; // Return null if container not found
        const messageElement = document.createElement('p');
        messageElement.textContent = text;
        messageElement.classList.add(`${type}-message`);
        container.appendChild(messageElement);
        // Scroll the specific container or the main content area
        const scrollTarget = document.getElementById('chat-widget-main-content'); // Always scroll main content
        if(scrollTarget) scrollTarget.scrollTop = scrollTarget.scrollHeight;
        return messageElement; // Return the created element
    }

    // Basic Markdown to HTML converter (CORRECTED)
    function markdownToHtml(md) {
        if (!md) return '';
        let html = md.trim();

        // **bold** to <strong>
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Process Blocks (Lists and Paragraphs)
        const blocks = html.split(/\n\s*\n/);
        let processedHtml = '';
        let currentListType = null; // null, 'ul', or 'ol'

        blocks.forEach(block => {
            const lines = block.split('\n');
            let isListBlock = lines.some(line => line.trim().match(/^(\d+\.|[\*\-])\s+/));

            if (isListBlock) {
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    let listMatch = trimmedLine.match(/^(\d+)\.\s+(.*)/); // Ordered list
                    let listType = 'ol';
                    if (!listMatch) {
                        listMatch = trimmedLine.match(/^[\*\-]\s+(.*)/); // Unordered list
                        listType = 'ul';
                    }

                    if (listMatch) {
                        const listItemContent = listType === 'ol' ? listMatch[2] : listMatch[1]; // Group 2 for OL, Group 1 for UL
                        if (currentListType !== listType) {
                            if (currentListType) processedHtml += `</${currentListType}>`; // Close previous list
                            processedHtml += `<${listType}>`;
                            currentListType = listType;
                        }
                        processedHtml += `<li>${listItemContent}</li>`;
                    } else {
                        // This line is not a list item within a list block (might be whitespace)
                        if (currentListType) {
                            processedHtml += `</${currentListType}>`; // Close current list
                            currentListType = null;
                        }
                        if (trimmedLine.length > 0) { // Treat as paragraph if not empty
                             processedHtml += `<p>${trimmedLine}</p>`;
                        }
                    }
                });
            } else {
                // Not a list block, treat as a paragraph
                if (currentListType) {
                     processedHtml += `</${currentListType}>`; // Close any open list
                     currentListType = null;
                }
                if (block.trim().length > 0) {
                    // Convert line breaks within paragraph block to <br>
                    processedHtml += `<p>${block.trim().replace(/\n/g, '<br>')}</p>`;
                }
            }
        });

         // Close any remaining open list
         if (currentListType) {
             processedHtml += `</${currentListType}>`;
         }

        return processedHtml;
    }

    // **UPDATED to use mock JSON data and reposition user query**
    function simulateBotResponse(userQueryText) {
       const mainContent = document.getElementById('chat-widget-main-content');
       const sidebar = document.getElementById('chat-widget-citations-sidebar');
       const messagesArea = document.getElementById('chat-widget-messages'); // Still used for bot msgs

       if (!mainContent || !sidebar || !messagesArea) return;

       // --- Clear previous dynamic content ---
       const existingArticle = document.getElementById('chat-widget-article-area');
       if (existingArticle) existingArticle.remove();
       messagesArea.innerHTML = ''; // Clear previous bot messages/thinking
       sidebar.innerHTML = ''; // Clear previous citations
       // Clear previous user messages directly added to mainContent
       mainContent.querySelectorAll('p.user-message').forEach(el => el.remove());
       // --- End Clear ---

       // Show spinner and add loading class
       const spinnerElement = document.getElementById('chat-widget-spinner');
       if(spinnerElement) spinnerElement.style.display = 'block';
       mainContent.classList.add('loading');

       // 1. Add User Query to Main Content FIRST
       const userMessageElement = document.createElement('p');
       userMessageElement.textContent = userQueryText;
       userMessageElement.className = 'user-message';
       mainContent.appendChild(userMessageElement); // Add user query above everything else
       // Scroll main content down slightly past user message
       mainContent.scrollTop = mainContent.scrollHeight;

       // 2. Add Thinking Message (to messagesArea, will appear below future article)
       const thinkingMsg = addMessage('Thinking...', 'thinking', 'chat-widget-messages');

       // Simulate fetching data
       setTimeout(() => {
            if(thinkingMsg) thinkingMsg.remove(); // Remove thinking message

            // Assume we fetched 'mockLLMResponse' based on userQueryText
            const responseData = mockLLMResponse; // Using the global mock data for now

            // 3. Create and Insert Article Content (using mock data)
            const articleArea = document.createElement('div');
            articleArea.id = 'chat-widget-article-area';

            // Build article HTML from JSON
            let articleHeaderHtml = '';
            let articleBodyHtml = '';
            let productCarouselHtml = ''; // Define outside if block
            if (responseData.article) {
                const article = responseData.article;

                // Header Part (Icon + Title + Source)
                articleHeaderHtml += `<div class="article-header-section" style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 5px;">`;
                articleHeaderHtml += agentIconSvg; // Add agent icon
                articleHeaderHtml += `<div style="flex-grow: 1;">`; // Wrapper for title and source
                articleHeaderHtml += `<h2 style="margin:0; padding:0; line-height:1.2;">${article.title || ''}</h2>`;
                if (article.source && article.source.text && article.source.url) {
                    articleHeaderHtml += `<a href="${article.source.url}" target="_blank" class="source-link" style="margin-bottom: 0;">${article.source.text}</a>`;
                }
                articleHeaderHtml += `</div></div>`; // Close wrapper and section

                // Product Carousel Section
                if (article.relatedProducts && article.relatedProducts.length > 0) {
                    productCarouselHtml += `<div id="chat-widget-product-carousel">`;
                    productCarouselHtml += `<h4>Related Products</h4>`;
                    productCarouselHtml += `<div class="chat-widget-carousel-wrapper">`;

                    article.relatedProducts.forEach(product => {
                        productCarouselHtml += `<div class="chat-widget-product-item">`;
                        productCarouselHtml += `<img src="${product.imageUrl}" alt="${product.name}">`;
                        productCarouselHtml += `<div class="product-name">${product.name}</div>`;
                        productCarouselHtml += `<div class="product-price">`;
                        if (product.originalPrice) {
                            productCarouselHtml += `<del>$${product.originalPrice}</del> `; // Strikethrough original price
                        }
                        productCarouselHtml += `$${product.salePrice}`; // Sale price
                        productCarouselHtml += `</div>`;
                        if (product.tags) {
                            productCarouselHtml += `<div class="product-tags">${product.tags}</div>`;
                        }
                        productCarouselHtml += `</div>`; // Close product-item
                    });

                    productCarouselHtml += `</div>`; // Close carousel-wrapper
                    productCarouselHtml += `</div>`; // Close product-carousel
                }

                // Body Part (Content converted from Markdown)
                articleBodyHtml += markdownToHtml(article.bodyMarkdown); // Convert Markdown body

                // Combine header, product carousel (if any), and body
                articleArea.innerHTML = articleHeaderHtml + productCarouselHtml + articleBodyHtml;
            }

            // Insert the article content *before* the messages area in the DOM flow
            mainContent.insertBefore(articleArea, messagesArea);

            // 4. Create and Insert Citations (using mock data)
            let citationsHtml = '<h4>Citations</h4>';
            if (responseData.citations && responseData.citations.length > 0) {
                citationsHtml += '<ul>';
                responseData.citations.forEach(citation => {
                    const domainInfoHtml = citation.domain ?
                        `<div class="citation-domain-info">${domainIconSvg} <span>${citation.domain}</span></div>`
                        : ''; // Only add if domain exists
                    citationsHtml += `
                        <li>
                            ${domainInfoHtml}
                            <a href="${citation.url || '#'}" target="_blank">${citation.title || 'Source'}</a>
                            <span>${citation.snippet || ''}</span>
                        </li>`;
                });
                citationsHtml += '</ul>';
            } else {
                 citationsHtml += '<p>No citations available.</p>'; // Handle no citations
            }
            sidebar.innerHTML = citationsHtml;

             // Scroll main content area to the top of the *article* after loading
             if (articleArea) {
                 // Scroll slightly above the article area for padding
                 mainContent.scrollTop = Math.max(0, articleArea.offsetTop - 20);
             } else {
                 mainContent.scrollTop = 0; // Fallback scroll to top
             }

             // Hide spinner and remove loading class
             if(spinnerElement) spinnerElement.style.display = 'none';
             mainContent.classList.remove('loading');

        }, 1500); // Simulate network delay
    }

    // --- Panel State Management Functions ---

    function expandPanel() {
        const panel = document.getElementById('chat-widget-panel');
        const body = panel.querySelector('.chat-widget-body');
        const popularQuestionsContainer = panel.querySelector('.chat-widget-popular-questions-container');
        let sidebar = document.getElementById('chat-widget-citations-sidebar');

        if (!isExpanded) {
            panel.classList.add('expanded');
            isExpanded = true;
            hasChatStarted = true; // Expanding implies chat has started

            // Hide popular questions
            if(popularQuestionsContainer) popularQuestionsContainer.style.display = 'none';

            // Create sidebar if it doesn't exist
            if (!sidebar) {
                sidebar = document.createElement('div');
                sidebar.id = 'chat-widget-citations-sidebar';
                body.appendChild(sidebar); // Append to body
            }
            sidebar.style.display = 'block'; // Ensure it's visible
            body.classList.add('has-sidebar'); // Activate flex row layout
        }
    }

    function shrinkPanel() {
        const panel = document.getElementById('chat-widget-panel');
        const body = panel.querySelector('.chat-widget-body');
        const sidebar = document.getElementById('chat-widget-citations-sidebar');
        const popularQuestionsContainer = panel.querySelector('.chat-widget-popular-questions-container');

        if (isExpanded) {
            panel.classList.remove('expanded');
            isExpanded = false;

            // Hide sidebar and remove layout class
            if(sidebar) sidebar.style.display = 'none';
            body.classList.remove('has-sidebar');

            // Show popular questions ONLY if chat hasn't really started (might need adjustment based on desired UX)
            if (!hasChatStarted && popularQuestionsContainer) {
                 popularQuestionsContainer.style.display = '';
            }

            // Restore header and footer visibility (remove display:none effect)
             const headerElement = panel.querySelector('.chat-widget-header');
             const footerElement = panel.querySelector('.chat-widget-footer');
             if(headerElement) headerElement.style.display = ''; // Reset display potentially set to none by .expanded
             if(footerElement) footerElement.style.display = ''; // Reset display potentially set to none by .expanded

            // Remove dynamically added article content when shrinking back? Optional.
            // const articleArea = document.getElementById('chat-widget-article-area');
            // if (articleArea) articleArea.remove();
            // // Clear sidebar?
            // if (sidebar) sidebar.innerHTML = '';
            // // Clear messages?
            // const messagesArea = document.getElementById('chat-widget-messages');
            // if (messagesArea) messagesArea.innerHTML = '';
        }
    }

    function togglePanel() {
        const panel = document.getElementById('chat-widget-panel');
        const chatInput = document.getElementById('chat-widget-input');

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
            // Don't automatically shrink when closing, keep the state
            // If it was expanded, it stays conceptually expanded but hidden
        } else {
            panel.classList.add('open');
            // If chat has started and it's not already expanded, expand it.
            // Note: expandPanel() now sets hasChatStarted=true
            if (hasChatStarted && !isExpanded) {
                 expandPanel();
            }
             // Auto-focus input when opened (only if not expanded/full screen)
            if (!isExpanded) {
                setTimeout(() => chatInput.focus(), 50);
            }
        }
    }

    // --- Dynamic Element Creation ---
    function createWidget() {
        // 1. Inject CSS
        const styleSheet = document.getElementById('chat-widget-styles');
        if (styleSheet) styleSheet.textContent = styles;
        else {
            const styleTag = document.createElement('style');
            styleTag.id = 'chat-widget-styles';
            styleTag.textContent = styles;
            document.head.appendChild(styleTag);
        }

        // 2. Create main container
        const container = document.createElement('div');
        container.id = 'chat-widget-container';

        // 3. Create chat icon
        const iconButton = document.createElement('button');
        iconButton.id = 'chat-widget-icon';
        iconButton.innerHTML = chatIconContent;
        iconButton.setAttribute('aria-label', 'Open Chat');

        // 4. Create chat panel
        const panel = document.createElement('div');
        panel.id = 'chat-widget-panel';

        // 5. Create panel header
        const header = document.createElement('div');
        header.className = 'chat-widget-header';

        const headerLeft = document.createElement('div'); // Group logo & title
        headerLeft.className = 'chat-widget-header-left';
        const logoImg = document.createElement('img');
        logoImg.src = 'https://ad.net/wp-content/themes/wp-adnet/assets/images/adnet.svg';
        logoImg.alt = 'Logo';
        const headerTitle = document.createElement('h3');
        headerTitle.id = 'chat-widget-header-title'; // ID for potential updates
        headerTitle.textContent = panelHeaderTitle;
        headerLeft.appendChild(logoImg);
        headerLeft.appendChild(headerTitle);

        const headerRight = document.createElement('div'); // Group buttons
        headerRight.className = 'chat-widget-header-right';
        const shrinkButton = document.createElement('button'); // **Shrink Button (still inside header)**
        shrinkButton.id = 'chat-widget-shrink-btn';
        shrinkButton.className = 'chat-widget-header-btn';
        shrinkButton.innerHTML = shrinkIcon;
        shrinkButton.setAttribute('aria-label', 'Shrink Chat');
        shrinkButton.addEventListener('click', shrinkPanel); // Add listener for shrink button
        headerRight.appendChild(shrinkButton); // Add shrink button TO HEADER

        // *** Create Close Button (but don't add to header) ***
        const closeButton = document.createElement('button');
        closeButton.id = 'chat-widget-close-btn';
        // closeButton.className = 'chat-widget-header-btn'; // Don't need header class anymore
        closeButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        `;
        closeButton.setAttribute('aria-label', 'Close Chat');
        // Listener will be added later

        header.appendChild(headerLeft);
        header.appendChild(headerRight); // Add right group (with shrink button) to header

        // 6. Create panel body
        const body = document.createElement('div');
        body.className = 'chat-widget-body';

        // 6a. Create Popular Questions Container
        const popularQuestionsContainer = document.createElement('div');
        popularQuestionsContainer.className = 'chat-widget-popular-questions-container';
        const questionsTitle = document.createElement('h4');
        questionsTitle.textContent = 'Popular Questions';
        const questionList = document.createElement('ul');
        questionList.className = 'chat-widget-questions';
        const questionIconSvg = `
            <svg class="chat-widget-question-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-.229.287-.079.032c-.26.107-.64.026-1.153-.197l-.424-.187-.073.38.23.287.073.032c.417.178.92.22 1.352.22.417 0 .84-.03 1.148-.131l.424-.187.073-.38-.23-.287-.073-.032c-.276-.117-.502-.13-.617-.291l-.569-2.68c-.074-.34.042-.447.288-.47l.45-.083.082-.38-.229-.287zm1.57 4.734c.03-.147.03-.294.03-.431 0-.21-.04-.414-.12-.608l-.24-.63c-.18-.47-.51-.82-.98-1.06l-.27-.135c-.23-.115-.39-.29-.48-.51l-.08-.18c-.08-.19-.11-.39-.11-.59 0-.19.03-.37.08-.54l.09-.28c.17-.54.57-1 1.14-1.23l.29-.115c.26-.1.54-.14.82-.14.29 0 .57.04.83.13l.29.115c.57.23.97.69 1.14 1.23l.09.28c.05.17.08.35.08.54 0 .2-.03.4-.11.59l-.08.18c-.09.22-.25.395-.48.51l-.27.135c-.47.24-.8.59-1.06.98l-.24.63c-.08.194-.12.398-.12.608 0 .137 0 .284.03.431z"/>
            </svg>`; // Simple question mark icon
        popularQuestions.forEach(q => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#';
            link.innerHTML = questionIconSvg + `<span>${q.text}</span>`; // Wrap text in span
            link.dataset.query = q.query;
            link.addEventListener('click', (event) => {
                 event.preventDefault();
                 const query = link.dataset.query || q.text;
                 expandPanel(); // Ensure expanded view (also sets hasChatStarted)
                 simulateBotResponse(query); // Generate rich response, passing the query text
                 // Clear input only in the main chat widget, not bottom bar
                 const chatInputElem = document.getElementById('chat-widget-input');
                 const sendButtonElem = document.getElementById('chat-widget-send-btn');
                 if(chatInputElem) chatInputElem.value = '';
                 if(sendButtonElem) sendButtonElem.disabled = true;
                 // Close suggestions if open
                 const suggestionsContainerElem = document.getElementById('chat-widget-suggestions');
                 if (suggestionsContainerElem) suggestionsContainerElem.style.display = 'none';
            });
            listItem.appendChild(link);
            questionList.appendChild(listItem);
        });
        popularQuestionsContainer.appendChild(questionsTitle);
        popularQuestionsContainer.appendChild(questionList);

        // 6b. Create Main Content Area (will hold article + messages)
        const mainContent = document.createElement('div');
        mainContent.id = 'chat-widget-main-content';

        // 6b.1 Add Spinner Placeholder
        const spinner = document.createElement('div');
        spinner.id = 'chat-widget-spinner';
        mainContent.appendChild(spinner);

        // 6c. Create Messages Area (INSIDE main content)
        const messagesArea = document.createElement('div');
        messagesArea.id = 'chat-widget-messages';
        mainContent.appendChild(messagesArea); // Messages area is always inside main content

        // Add initial elements to body
        body.appendChild(popularQuestionsContainer); // Questions first
        body.appendChild(mainContent);            // Then main content (holding messages)
        // Sidebar is added dynamically on expansion

        // 7. Create panel footer
        const footer = document.createElement('div');
        footer.className = 'chat-widget-footer';
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.id = 'chat-widget-suggestions';
        const suggestionsList = document.createElement('ul');
        suggestionsContainer.appendChild(suggestionsList);
        footer.appendChild(suggestionsContainer);
        const chatInput = document.createElement('textarea');
        chatInput.id = 'chat-widget-input'; chatInput.placeholder = inputPlaceholder; chatInput.rows = 1;
        const sendButton = document.createElement('button');
        sendButton.id = 'chat-widget-send-btn'; sendButton.innerHTML = sendButtonIcon; sendButton.setAttribute('aria-label', 'Send Message'); sendButton.disabled = true;
        footer.appendChild(chatInput);
        footer.appendChild(sendButton);

        // 8. Assemble panel
        panel.appendChild(header);
        panel.appendChild(body);
        panel.appendChild(footer);
        panel.appendChild(closeButton); // *** Add standalone closeButton to PANEL ***

        // 9. Assemble container
        container.appendChild(iconButton);
        container.appendChild(panel);

        // 10. Append to body
        document.body.appendChild(container);

        // --- Event Listeners ---
        iconButton.addEventListener('click', togglePanel);

        // UPDATED Close Button Listener (Handles expanded state reset)
        closeButton.addEventListener('click', () => {
            const panel = document.getElementById('chat-widget-panel');
            panel.classList.remove('open'); // Close the panel visibility

            // If it was expanded (full screen), also reset everything for the shrunk state
            if (panel.classList.contains('expanded')) {
                panel.classList.remove('expanded');
                isExpanded = false; // Reset the expanded state variable

                // Reset body layout and hide sidebar
                const body = panel.querySelector('.chat-widget-body');
                const sidebar = document.getElementById('chat-widget-citations-sidebar');
                if(body) body.classList.remove('has-sidebar');
                if(sidebar) sidebar.style.display = 'none';

                // Restore header and footer visibility (remove display:none effect)
                 const headerElement = panel.querySelector('.chat-widget-header');
                 const footerElement = panel.querySelector('.chat-widget-footer');
                 // Explicitly set display back to flex (or initial style)
                 if(headerElement) headerElement.style.display = 'flex';
                 if(footerElement) footerElement.style.display = 'flex';

                 // Restore popular questions visibility if chat hasn't *really* started
                 const popularQuestionsContainer = panel.querySelector('.chat-widget-popular-questions-container');
                 // Check if article area exists to determine if chat *really* started
                 const articleArea = document.getElementById('chat-widget-article-area');
                 if (!articleArea && popularQuestionsContainer) {
                      popularQuestionsContainer.style.display = ''; // Show questions again
                      hasChatStarted = false; // Reset chat started if going back to questions
                 }
                 // Optional: Consider clearing dynamic content fully here if desired
            }
        });


        sendButton.addEventListener('click', () => {
            const messageText = chatInput.value.trim();
            if (messageText) {
                expandPanel(); // Ensure expanded view (also sets hasChatStarted)
                simulateBotResponse(messageText); // Generate rich response, passing text

                chatInput.value = '';
                sendButton.disabled = true;
                chatInput.style.height = '40px'; // Reset height
                suggestionsContainer.style.display = 'none';
                // Don't refocus input in expanded mode as it's hidden
                // chatInput.focus();
            }
        });

        // Input listener (suggestions, resize, enable button)
        chatInput.addEventListener('input', () => {
            const trimmedValue = chatInput.value.trim();
            sendButton.disabled = trimmedValue.length === 0;
            // Auto-resize
            chatInput.style.height = 'auto';
            const scrollHeight = chatInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(chatInput).maxHeight, 10);
            const minHeight = parseInt(window.getComputedStyle(chatInput).minHeight, 10);
            let newHeight = Math.max(minHeight, scrollHeight);
            newHeight = Math.min(newHeight, maxHeight);
            chatInput.style.height = `${newHeight}px`;
            // Autocomplete
            const currentInput = chatInput.value.toLowerCase().trim();
            suggestionsList.innerHTML = '';
            if (currentInput.length > 0) {
                const filteredSuggestions = autocompleteSuggestions.filter(s => s.toLowerCase().includes(currentInput));
                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.slice(0, 5).forEach(suggestionText => {
                        const li = document.createElement('li');
                        li.textContent = suggestionText;
                        li.addEventListener('click', () => {
                            chatInput.value = suggestionText;
                            suggestionsContainer.style.display = 'none';
                            sendButton.disabled = false;
                            chatInput.focus();
                            chatInput.dispatchEvent(new Event('input')); // Trigger input event for height adjust etc.
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsContainer.style.display = 'block';
                } else { suggestionsContainer.style.display = 'none'; }
            } else { suggestionsContainer.style.display = 'none'; }
        });

        // Enter key listener
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && !sendButton.disabled) {
                event.preventDefault();
                sendButton.click();
            }
        });

        // Click outside suggestions listener
        document.addEventListener('click', function(event) {
            if (!footer.contains(event.target) && suggestionsContainer.style.display === 'block') {
                 suggestionsContainer.style.display = 'none';
            }
        });
    }

    // --- Initialization ---
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createWidget);
    } else {
        createWidget();
    }

    // --- Expose functions for external use (e.g., bottom search bar) ---
    window.chatWidget = {
        togglePanel,
        expandPanel,
        shrinkPanel, // Expose shrink if needed elsewhere
        simulateBotResponse,
        // Add other functions here if needed
        getIsExpanded: () => isExpanded, // Function to check state if needed
        setHasChatStarted: (value) => { hasChatStarted = !!value; } // Allow setting chat started state
    };

})();
</script>

<!-- Bottom Search Bar HTML -->
<div id="bottom-search-bar">
    <img id="search-bar-gr-logo" src="gamerevolution.png" alt="GameRevolution Logo">
    <input type="text" id="search-bar-input" placeholder="Looking for the best option? Try me!" autocomplete="off">
    <button id="search-bar-button" aria-label="Submit Search" style="padding-right: 2px;">
        <!-- Paper Plane Send Icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="#FF007A"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
    <!-- Autocomplete Suggestions Container -->
    <div id="bottom-search-suggestions">
        <h4>Popular Questions</h4>
        <ul></ul>
    </div>
</div>

<!-- Script for Bottom Search Bar Autocomplete -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-bar-input');
    const suggestionsContainer = document.getElementById('bottom-search-suggestions');
    const suggestionsList = suggestionsContainer.querySelector('ul');
    const searchButton = document.getElementById('search-bar-button');

    // Use the same questions as the chat widget for consistency
    const popularGameQuestions = [
        'What monitor is best for competitive FPS?',
        'How do I choose the right gaming chair?',
        'What are some great ways to fix up a backyard?',
        'Where can I find PS5 stock updates?',
        'What\'s the return policy on peripherals?' // Escaped apostrophe
    ];

    // Function to show suggestions
    function showSuggestions() {
        suggestionsList.innerHTML = ''; // Clear previous suggestions
        const searchIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#6c757d" class="bi bi-search suggestion-icon" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0\"/></svg>';
        popularGameQuestions.forEach(question => {
            const li = document.createElement('li');
            li.innerHTML = searchIconSvg + `<span>${question}</span>`; // Add icon and wrap text in span
            li.addEventListener('click', () => {
                const queryText = question; // Use the clicked question text
                searchInput.value = question; // Keep the value temporarily to show selection
                suggestionsContainer.style.display = 'none';

                // --- Trigger full screen chat response ---
                if (queryText && window.chatWidget) { // Check if widget functions are exposed
                    const chatPanel = document.getElementById('chat-widget-panel');

                    // Ensure panel element exists and is open before expanding
                    if (chatPanel && !chatPanel.classList.contains('open')) {
                        window.chatWidget.togglePanel(); // Open it if closed
                    }

                    // Set chat started state (since user interacted intentionally)
                    window.chatWidget.setHasChatStarted(true);

                    // Expand to full screen and simulate response
                    window.chatWidget.expandPanel();
                    window.chatWidget.simulateBotResponse(queryText);

                    // Reset bottom search bar input
                    searchInput.value = ''; // Clear after sending to chat
                }
                // --- End trigger ---

            });
            suggestionsList.appendChild(li);
        });
        suggestionsContainer.style.display = 'block';
    }

    // Function to hide suggestions
    function hideSuggestions() {
        // Delay hiding to allow click events on suggestions to register
        setTimeout(() => {
             // Check if the input still has focus - don't hide if user is typing
            // REMOVED: Check if input still has focus. The mousedown listener on suggestions handles clicks.
            // if(document.activeElement !== searchInput) { 
                 suggestionsContainer.style.display = 'none';
            // }
        }, 150); // Keep the delay to allow clicks on suggestions
    }

    // Event listeners
    searchInput.addEventListener('focus', showSuggestions);
    searchInput.addEventListener('blur', hideSuggestions); // Hide when losing focus

    // Keep suggestions open if clicking inside the suggestions list
    suggestionsContainer.addEventListener('mousedown', (event) => {
        // Prevent the blur event on the input from firing immediately
        event.preventDefault();
    });

    // Optional: Hide if clicking completely outside the search bar area
    document.addEventListener('click', (event) => {
        const searchBar = document.getElementById('bottom-search-bar');
        // Check if the click is outside the search bar AND outside the suggestions
        if (!searchBar.contains(event.target) && !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

     // Handle Enter key press in search input
     searchInput.addEventListener('keypress', (event) => {
         if (event.key === 'Enter') {
             event.preventDefault(); // Prevent default form submission if wrapped in form
             searchButton.click(); // Trigger the search button click handler
         }
     });


    // --- Add listener to bottom search button ---
    searchButton.addEventListener('click', () => {
        const queryText = searchInput.value.trim();
        if (queryText && window.chatWidget) { // Check if query exists and widget functions are exposed
            const chatPanel = document.getElementById('chat-widget-panel');

            // Ensure panel element exists and is open before expanding
            if (chatPanel && !chatPanel.classList.contains('open')) {
                window.chatWidget.togglePanel(); // Open it if closed
            }

             // Set chat started state (since user interacted intentionally)
             window.chatWidget.setHasChatStarted(true);

            // Expand to full screen and simulate response
            window.chatWidget.expandPanel();
            window.chatWidget.simulateBotResponse(queryText);

            // Reset bottom search bar
            searchInput.value = '';
            suggestionsContainer.style.display = 'none'; // Hide suggestions list explicitly
            searchInput.blur(); // Remove focus from the search bar
        }
    });
});
</script>

</body>
</html>